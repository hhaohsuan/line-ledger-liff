<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸³æœ¬è¨­å®š</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    button { padding: 10px 20px; font-size: 16px; background: #06c755; color: white; border: none; border-radius: 5px; margin-top: 10px; }
    .status { margin-top: 10px; color: #666; font-size: 14px; word-break: break-all; }
  </style>
</head>
<body>
  <h2>âš™ï¸ å¸³æœ¬è¨­å®š (GitHubç‰ˆ)</h2>
  <div id="status">æº–å‚™ä¸­...</div>
  <div id="data-area" style="margin-top:20px; font-weight:bold;"></div>
  <button id="actionBtn" style="display:none;" onclick="saveTest()">æ¸¬è©¦å„²å­˜</button>

  <script>
    // ğŸ‘‡ å¡«å…¥ä½ çš„è³‡æ–™ ğŸ‘‡
    const MY_LIFF_ID = '2009010836-1OaNzGM2'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyg1m3O5c9SjDhAbGIPFd1AAZyiTtwpc5IqWcJ8fXQZND3ghJqX2hDtTL53Y4ZkB9fi/exec';

    const statusEl = document.getElementById('status');
    let currentUserId = '';

    function log(msg) { statusEl.innerText = msg; console.log(msg); }

    async function main() {
      try {
        log('1. åˆå§‹åŒ– LIFF...');
        await liff.init({ liffId: MY_LIFF_ID });

        if (!liff.isLoggedIn()) {
          log('æœªç™»å…¥ï¼Œè·³è½‰ä¸­...');
          liff.login({ redirectUri: location.href }); // é€™è£¡å¯ä»¥ç”¨ location.href äº†ï¼
          return;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;
        log('âœ… ç™»å…¥æˆåŠŸï¼š' + profile.displayName);
        
        // å‘¼å« GAS API
        loadDataFromGAS(currentUserId);

      } catch (err) {
        log('âŒ éŒ¯èª¤: ' + err.message);
      }
    }

    // æ”¹ç”¨ fetch å‘¼å« GAS
    function loadDataFromGAS(uid) {
      log('æ­£åœ¨å‘¼å« GAS API...');
      
      fetch(GAS_API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getLedgerConfig', userId: uid }),
        // âš ï¸ GAS ä¸éœ€è¦ Content-Type headerï¼ŒåŠ äº†æœ‰æ™‚å€™æœƒè·¨åŸŸå¤±æ•—ï¼Œç”¨é è¨­å°±å¥½
      })
      .then(res => res.json())
      .then(json => {
        if(json.success) {
          log('âœ… è®€å–æˆåŠŸï¼');
          document.getElementById('data-area').innerText = 'å¸³æœ¬åç¨±ï¼š' + json.ledgerName;
          document.getElementById('actionBtn').style.display = 'inline-block';
        } else {
          log('âŒ å¾Œç«¯å›å‚³éŒ¯èª¤: ' + json.error);
        }
      })
      .catch(err => log('âŒ Fetch å¤±æ•—: ' + err));
    }

    function saveTest() {
      log('å„²å­˜ä¸­...');
      fetch(GAS_API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'saveLedgerConfig', userId: currentUserId, data: { text: 'test' } })
      })
      .then(res => res.json())
      .then(json => log('âœ… ' + json.message))
      .catch(err => log('âŒ å„²å­˜å¤±æ•—'));
    }

    main();
  </script>
</body>
</html>
