<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è¨˜ä¸€ç­†</title>
  <style>
    :root { --primary: #06c755; --bg: #f7f9fc; --text: #333; --border: #e1e5eb; --red: #ff4b4b; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); -webkit-tap-highlight-color: transparent; }
    
    .header { background: white; padding: 15px 20px; box-shadow: 0 1px 0 var(--border); position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    .close-btn { font-size: 24px; color: #888; cursor: pointer; line-height: 1; }

    .container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    
    label { font-size: 13px; color: #888; margin-bottom: 8px; display: block; font-weight: 500; }
    
    .input-group { position: relative; display: flex; align-items: center; }
    input, select, textarea { width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 12px; background: #f9f9f9; box-sizing: border-box; transition: all 0.2s; }
    input:focus, select:focus, textarea:focus { background: white; border-color: var(--primary); outline: none; }
    
    #amount-input { font-size: 28px; font-weight: bold; color: var(--primary); text-align: right; padding-right: 15px; }
    .calc-icon { position: absolute; left: 15px; color: #ccc; font-size: 20px; }

    .currency-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
    .c-btn { flex: 1; padding: 10px; text-align: center; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: 500; color: #666; background: white; }
    .c-btn.active { background: #e8f9ee; color: var(--primary); border-color: var(--primary); font-weight: bold; }

    .loading-spin { display: none; width: 16px; height: 16px; border: 2px solid #ddd; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* åˆ†å¸³ä»‹é¢ */
    .split-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .split-tools { display: flex; gap: 10px; font-size: 12px; color: var(--primary); }
    .tool-btn { cursor: pointer; font-weight: 600; padding: 4px 8px; background: #e8f9ee; border-radius: 6px; }

    .split-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .split-row:last-child { border-bottom: none; }
    .user-info { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; }
    
    .checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .checkbox.checked { background: var(--primary); border-color: var(--primary); }
    .checkbox.checked::after { content: 'âœ”'; color: white; font-size: 14px; }
    
    .avatar { width: 36px; height: 36px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; font-size: 14px; }
    
    .split-amount { width: 100px !important; text-align: right; padding: 8px !important; font-size: 15px !important; }
    .split-amount:disabled { background: transparent; border: none; color: #333; font-weight: bold; }

    .footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: white; border-top: 1px solid var(--border); display: flex; gap: 10px; box-sizing: border-box; }
    .btn-main { flex: 1; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(6,199,85,0.3); }
    .btn-main:disabled { background: #ccc; box-shadow: none; }

    .split-summary { text-align: center; margin-bottom: 10px; font-size: 14px; color: #666; background: #e8f9ee; padding: 8px; border-radius: 8px; display: flex; justify-content: space-between; }
    .status-ok { color: var(--primary); font-weight: bold; }
    .status-err { color: var(--red); font-weight: bold; }

/* --- è‡ªè£½è¨ˆç®—æ©Ÿæ¨£å¼ (ä¿®æ­£ç‰ˆé¢) --- */
    .calc-overlay { position: fixed; bottom: -100%; left: 0; width: 100%; background: #f2f2f7; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 1000; padding: 15px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); box-sizing: border-box; }
    .calc-overlay.show { bottom: 0; }
    
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: 10px; height: 380px; }
    
    .calc-btn { 
      background: white; border: none; border-radius: 12px; font-size: 24px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; color: #333; font-weight: 400;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent;
      height: 100%; width: 100%;
    }
    .calc-btn:active { background: #e5e5e5; }
    
    .btn-op { background: #ff9f0a; color: white; font-weight: 500; font-size: 28px; } /* é‹ç®—ç¬¦è™Ÿæ©˜è‰² */
    .btn-op:active { background: #e68a00; }
    .btn-eq { background: var(--primary); color: white; font-weight: bold; grid-row: span 2; } /* OKéµç¶ è‰² */
    .btn-eq:active { opacity: 0.8; }
    .btn-ac { background: #d4d4d2; color: #333; font-weight: 500; } /* æ¸…é™¤éµç°è‰² */
    .btn-ac:active { background: #c0c0c0; }
    
    .input-readonly { cursor: pointer; background: white !important; color: var(--primary); caret-color: transparent; }
  </style>
</head>
<body>

<div class="header">
  <div class="close-btn" onclick="liff.closeWindow()">âœ•</div>
  <h1>æ–°å¢è¨˜å¸³</h1>
  <div style="width:24px"></div>
</div>

<div class="container">
  
  <div class="card">
    <label>æ—¥æœŸ & æ™‚é–“</label>
    <input type="datetime-local" id="date-input">
  </div>

  <div class="card">
    <label>å“é … <span id="predict-loading" class="loading-spin"></span></label>
    <input type="text" id="item-input" placeholder="è¼¸å…¥å…§å®¹..." onblur="predictCategory()">
    <label style="margin-top: 15px;">åˆ†é¡</label>
    <select id="category-select"><option>è¼‰å…¥ä¸­...</option></select>
  </div>

<div class="card">
    <div class="currency-toggle" id="currency-box"></div>

    <label>é‡‘é¡</label>
    <div class="input-group">
      <span class="calc-icon">ï¹©</span>
      <input type="text" id="amount-input" class="input-readonly" placeholder="0" 
             readonly onclick="openCalculator()">
    </div>

    <div id="twd-convert-row" style="margin-top: 15px; display: none;">
      <label>ğŸ’³ åˆ·å¡é€šçŸ¥å°å¹£é‡‘é¡ (é¸å¡«)</label>
      <input type="number" id="amount-twd-input" placeholder="å¯¦éš›æ‰£æ¬¾å°å¹£é‡‘é¡" style="background:#fff8e1; border-color:#ffe082;">
    </div>
  </div>

  <div id="custom-calculator" class="calc-overlay">
     <div class="calc-grid">
        <button class="calc-btn btn-ac" onclick="calcAppend('AC')">AC</button>
        <button class="calc-btn btn-ac" onclick="calcAppend('DEL')">âŒ«</button>
        <button class="calc-btn btn-op" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn btn-op" onclick="calcAppend('*')">Ã—</button>

        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn btn-op" onclick="calcAppend('-')">-</button>

        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn btn-op" onclick="calcAppend('+')">+</button>

        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        
        <button class="calc-btn btn-eq" style="grid-row: span 2;" onclick="calcDone()">OK</button>

        <button class="calc-btn" style="grid-column: span 2" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
     </div>
  </div>
    <div id="twd-convert-row" style="margin-top: 15px; display: none;">
      <label>ğŸ’³ åˆ·å¡é€šçŸ¥å°å¹£é‡‘é¡ (é¸å¡«)</label>
      <input type="number" id="amount-twd-input" placeholder="å¯¦éš›æ‰£æ¬¾å°å¹£é‡‘é¡" style="background:#fff8e1; border-color:#ffe082;">
    </div>
  </div>

  <div class="card">
    <div style="display:flex; gap:10px;">
      <div style="flex:1">
        <label>å…ˆä»˜éŒ¢çš„äºº</label>
        <select id="payer-select"></select>
      </div>
      <div style="flex:1">
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="payment-select"></select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="split-header">
        <label style="margin:0">å¦‚ä½•åˆ†å¸³</label>
        <div class="split-tools">
           <div class="tool-btn" onclick="toggleSelectAll()">å…¨é¸/å–æ¶ˆ</div>
           <div class="tool-btn" onclick="toggleSplitMode()">åˆ‡æ›æ‰‹å‹•è¼¸å…¥</div>
        </div>
    </div>
    
    <div class="split-summary">
      <span>ç¸½é¡: <span id="total-display">0</span></span>
      <span id="remainder-display" class="status-ok">å‰©é¤˜: 0</span>
    </div>

    <div id="split-list"></div>
    <textarea id="note-input" rows="2" placeholder="å‚™è¨»..." style="margin-top:15px;"></textarea>
  </div>

</div>

<div class="footer">
  <button class="btn-main" id="save-btn" onclick="save()">ç¢ºèªå„²å­˜</button>
</div>

<input type="hidden" id="edit-row-index">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ğŸ”´ è«‹å¡«å…¥ä½ çš„è³‡è¨Š
  const LIFF_ID = "2009010836-bedIz9Jo"; 
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwgI2bbO-8SU94pv-G7BU2MBHS2j6BjzTxFgC3YcX0bv0KLHROsi8mRaJ3FiuiefMB1/exec";

  let settings = { members: [], categories: [], payments: [], currency: "TWD" };
  let currentCurrency = "TWD";
  let splitMode = "EVEN"; // "EVEN" (å‹¾é¸) æˆ– "CUSTOM" (æ‰‹è¼¸)
  let userId = "";

  window.onload = function() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('date-input').value = now.toISOString().slice(0,16);

    liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        liff.getProfile().then(profile => {
            userId = profile.userId;
            loadData();
        });
    });
  };

  async function loadData() {
    const urlParams = new URLSearchParams(window.location.search);
    const editRow = urlParams.get('row');
    const action = editRow ? 'getEditData' : 'getSettings';

    try {
      const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action, userId, row: editRow }) }).then(r=>r.json());
      if(res.success) {
         settings = res.data;
         renderSelect('category-select', settings.categories);
         renderSelect('payer-select', settings.members);
         renderSelect('payment-select', settings.payments);
         renderCurrencyUI(settings.currency);
         renderSplitList();
         
         if(editRow && res.record) fillForm(res.record);
         else {
            if(settings.members.length > 0) document.getElementById('payer-select').value = settings.members[0];
            // é è¨­å…¨é¸
            toggleSelectAll(true);
         }
      }
    } catch(e) { alert("è¼‰å…¥éŒ¯èª¤: " + e); }
  }

  function renderSelect(id, list) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    (list||[]).forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
  }

  function renderCurrencyUI(mainCurrency) {
    const box = document.getElementById('currency-box');
    box.innerHTML = "";
    const btn1 = document.createElement('div');
    btn1.className = "c-btn active"; btn1.innerText = mainCurrency;
    btn1.onclick = () => setCurrency(mainCurrency, btn1);
    box.appendChild(btn1);
    currentCurrency = mainCurrency;

    if (mainCurrency !== "TWD") {
        const btn2 = document.createElement('div');
        btn2.className = "c-btn"; btn2.innerText = "TWD";
        btn2.onclick = () => setCurrency("TWD", btn2);
        box.appendChild(btn2);
    }
    updateTwdInputVisibility();
  }

  function setCurrency(code, btnElement) {
    currentCurrency = code;
    document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');
    updateTwdInputVisibility();
  }

  function updateTwdInputVisibility() {
    const show = (settings.currency !== "TWD" && currentCurrency !== "TWD");
    document.getElementById('twd-convert-row').style.display = show ? 'block' : 'none';
  }

  function calculateMath(el) {
    try {
      if (/^[0-9+\-*/.() ]+$/.test(el.value)) {
         el.value = eval(el.value); 
         updateSplitMath();
      }
    } catch(e) {}
  }

  async function predictCategory() {
    const item = document.getElementById('item-input').value.trim();
    if(!item) return;
    document.getElementById('predict-loading').style.display = 'inline-block';
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'predictCategory', item: item, categories: settings.categories })
      }).then(r=>r.json());
      if(res.success && res.category) document.getElementById('category-select').value = res.category;
    } catch(e) {}
    finally { document.getElementById('predict-loading').style.display = 'none'; }
  }

  // --- åˆ†å¸³æ ¸å¿ƒ ---
  function renderSplitList() {
    const list = document.getElementById('split-list');
    
    // å¦‚æœæ˜¯åˆæ¬¡æ¸²æŸ“ä¸”åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œå…ˆä¿ç•™æ—¢æœ‰çš„å‹¾é¸ç‹€æ…‹ (å¦‚æœæ˜¯é‡æ–°æ¸²æŸ“)
    // é€™è£¡ç°¡å–®é‡ç¹ª
    const oldHtml = list.innerHTML;
    list.innerHTML = "";
    
    settings.members.forEach((member, idx) => {
      // æª¢æŸ¥ä¹‹å‰æ˜¯å¦å‹¾é¸ (å¦‚æœåªæ˜¯åˆ‡æ›æ¨¡å¼ï¼Œä¿æŒå‹¾é¸ç‹€æ…‹)
      const wasChecked = oldHtml ? (document.getElementById(`chk-${idx}`)?.classList.contains('checked')) : true;
      
      const row = document.createElement('div');
      row.className = "split-row";
      const initial = member.substring(0,1);
      const checkHtml = splitMode === "EVEN" ? `<div class="checkbox ${wasChecked?'checked':''}" id="chk-${idx}"></div>` : ``;
      const inputDisabled = splitMode === "EVEN" ? "disabled" : "";
      
      row.innerHTML = `
        <div class="user-info" onclick="toggleMember(${idx})">
           ${checkHtml}
           <div class="avatar" style="margin-left:${splitMode==='EVEN'?10:0}px">${initial}</div>
           <div style="font-weight:500">${member}</div>
        </div>
        <input type="number" class="split-amount" id="amt-${idx}" placeholder="0" ${inputDisabled} onkeyup="calcRemainder()">
      `;
      list.appendChild(row);
    });
    updateSplitMath();
  }

  function toggleSplitMode() {
    splitMode = splitMode === "EVEN" ? "CUSTOM" : "EVEN";
    renderSplitList();
  }

  function toggleMember(idx) {
    if (splitMode !== "EVEN") return;
    const chk = document.getElementById(`chk-${idx}`);
    chk.classList.toggle('checked');
    updateSplitMath();
  }

  // âœ… å…¨é¸/å…¨å–æ¶ˆåŠŸèƒ½
  function toggleSelectAll(forceSelect = null) {
    if (splitMode !== "EVEN") return; // åªæœ‰å‡åˆ†æ¨¡å¼èƒ½å…¨é¸

    const allChecks = document.querySelectorAll('.checkbox');
    // å¦‚æœå‚³å…¥ forceSelect å‰‡å¼·åˆ¶è¨­å®šï¼Œå¦å‰‡åˆ¤æ–·ç›®å‰ç‹€æ…‹
    // é‚è¼¯ï¼šåªè¦æœ‰ä¸€å€‹æ²’å‹¾ï¼Œå°±å…¨é¸ï¼›å¦‚æœéƒ½å‹¾äº†ï¼Œå°±å…¨å–æ¶ˆ
    let shouldSelectAll = true;
    if (forceSelect === null) {
       const allChecked = Array.from(allChecks).every(c => c.classList.contains('checked'));
       shouldSelectAll = !allChecked;
    } else {
       shouldSelectAll = forceSelect;
    }

    allChecks.forEach(c => {
       if(shouldSelectAll) c.classList.add('checked');
       else c.classList.remove('checked');
    });
    updateSplitMath();
  }

  function updateSplitMath() {
    const total = parseFloat(document.getElementById('amount-input').value) || 0;
    document.getElementById('total-display').innerText = total;

    if (splitMode === "EVEN") {
       const checks = document.querySelectorAll('.checkbox.checked');
       const count = checks.length;
       const perPerson = count > 0 ? Math.round((total / count) * 100) / 100 : 0;
       
       settings.members.forEach((m, i) => {
          const chk = document.getElementById(`chk-${i}`);
          const inp = document.getElementById(`amt-${i}`);
          if (chk && chk.classList.contains('checked')) {
             inp.value = perPerson;
          } else {
             inp.value = 0;
          }
       });
       document.getElementById('remainder-display').innerText = "è‡ªå‹•å‡åˆ†";
       document.getElementById('remainder-display').className = "status-ok";
    } else {
       calcRemainder();
    }
  }

  function calcRemainder() {
    const total = parseFloat(document.getElementById('amount-input').value) || 0;
    let currentSum = 0;
    settings.members.forEach((m, i) => {
       currentSum += parseFloat(document.getElementById(`amt-${i}`).value) || 0;
    });
    const diff = total - currentSum;
    const el = document.getElementById('remainder-display');
    if (Math.abs(diff) < 0.1) {
       el.innerText = "å‰›å¥½åˆ†å®Œ"; el.className = "status-ok";
    } else {
       el.innerText = diff > 0 ? `å‰©é¤˜ ${diff.toFixed(1)}` : `è¶…æ”¯ ${Math.abs(diff).toFixed(1)}`;
       el.className = "status-err";
    }
  }

  // âœ… æ ¸å¿ƒå„²å­˜é‚è¼¯ (è½‰æ›ç‚ºä½ çš„æ–‡å­—æ ¼å¼)
  function save() {
    let splitText = "";
    const totalMembers = settings.members.length;
    
    if (splitMode === "EVEN") {
       const checkedBoxes = document.querySelectorAll('.checkbox.checked');
       const checkedCount = checkedBoxes.length;

       if (checkedCount === totalMembers) {
          // æƒ…å¢ƒ 1: å…¨é¸ -> "å‡åˆ†"
          splitText = "å‡åˆ†";
       } else if (checkedCount === 1) {
          // æƒ…å¢ƒ 2: åªé¸ä¸€å€‹äºº -> "éƒ½Açš„"
          // æ‰¾å‡ºè¢«å‹¾é¸çš„äººå
          let targetName = "";
          settings.members.forEach((m, i) => {
             if (document.getElementById(`chk-${i}`).classList.contains('checked')) targetName = m;
          });
          splitText = "éƒ½" + targetName + "çš„";
       } else {
          // æƒ…å¢ƒ 3: éƒ¨åˆ†å‡åˆ† (ä¾‹å¦‚4å€‹äººåªé¸2å€‹) -> "Açš„50ã€Bçš„50" (ç›´æ¥å¯«å‡ºé‡‘é¡ä»¥å…æ··æ·†)
          let parts = [];
          settings.members.forEach((m, i) => {
             const chk = document.getElementById(`chk-${i}`);
             const val = parseFloat(document.getElementById(`amt-${i}`).value) || 0;
             if (chk && chk.classList.contains('checked')) {
                parts.push(`${m}çš„${val}`);
             }
          });
          splitText = parts.join("ã€");
       }
    } else {
       // æƒ…å¢ƒ 4: è‡ªè¨‚é‡‘é¡æ¨¡å¼ -> "Açš„10ã€Bçš„20"
       let parts = [];
       settings.members.forEach((m, i) => {
          const val = parseFloat(document.getElementById(`amt-${i}`).value) || 0;
          if (val > 0) {
             parts.push(`${m}çš„${val}`);
          }
       });
       splitText = parts.join("ã€");
    }

    const payload = {
      date: document.getElementById('date-input').value,
      item: document.getElementById('item-input').value,
      category: document.getElementById('category-select').value,
      amount: document.getElementById('amount-input').value,
      currency: currentCurrency,
      amountTWD: document.getElementById('amount-twd-input').value || null,
      payer: document.getElementById('payer-select').value,
      payment: document.getElementById('payment-select').value,
      split: splitText, // ğŸ‘ˆ é€™è£¡é€å‡ºè½‰æ›å¾Œçš„æ–‡å­—
      note: document.getElementById('note-input').value,
      row: document.getElementById('edit-row-index').value
    };

    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";

    fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveTransaction', userId: userId, data: payload })
    })
    .then(r=>r.json())
    .then(res => {
       if(res.success) liff.closeWindow();
       else { alert("å¤±æ•—: " + res.error); btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; }
    })
    .catch(e => { alert("éŒ¯èª¤: " + e); btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; });
  }

// ç·¨è¼¯æ¨¡å¼å›å¡« (å‡ç´šç‰ˆï¼šæ”¯æ´åè§£è‡ªè¨‚åˆ†å¸³)
  function fillForm(record) {
     document.getElementById('edit-row-index').value = window.location.search.split('row=')[1];
     document.getElementById('item-input').value = record.item;
     document.getElementById('amount-input').value = record.amount;
     document.getElementById('category-select').value = record.category;
     document.getElementById('payment-select').value = record.method;
     document.getElementById('payer-select').value = record.payer;
     document.getElementById('note-input').value = record.note;
     
     // è¨­å®šå¹£åˆ¥
     const isTwd = (record.currency === 'TWD');
     // æ‰¾åˆ°å°æ‡‰çš„å¹£åˆ¥æŒ‰éˆ• (å‡è¨­åªæœ‰å…©å€‹æŒ‰éˆ•: ä¸»å¹£åˆ¥ å’Œ TWD)
     const btns = document.querySelectorAll('.c-btn');
     if (isTwd && btns.length > 1) setCurrency('TWD', btns[1]);
     else setCurrency(record.currency, btns[0]);

     if(record.amountTWD) document.getElementById('amount-twd-input').value = record.amountTWD;

     // ğŸ§  åˆ†å¸³å›å¡«æ ¸å¿ƒé‚è¼¯
     const splitText = record.split || "";

     if (splitText === "å‡åˆ†") {
        // æƒ…å¢ƒ 1: å‡åˆ† -> å…¨é¸
        splitMode = "EVEN";
        toggleSelectAll(true); 

     } else if (splitText.startsWith("éƒ½") && splitText.endsWith("çš„")) {
        // æƒ…å¢ƒ 2: éƒ½Açš„ -> å‡åˆ†æ¨¡å¼ï¼Œåªå‹¾A
        splitMode = "EVEN";
        const name = splitText.substring(1, splitText.length - 1); // å»æ‰é ­å°¾
        toggleSelectAll(false); // å…ˆå…¨å–æ¶ˆ
        
        // å‹¾é¸è©²æˆå“¡
        settings.members.forEach((m, i) => {
           if(m === name) document.getElementById(`chk-${i}`).classList.add('checked');
        });

     } else if (splitText.includes("çš„")) {
        // æƒ…å¢ƒ 3: è‡ªè¨‚é‡‘é¡ (ä¾‹å¦‚ "Açš„10ã€Bçš„20")
        // æˆ–è€…æ˜¯ éƒ¨åˆ†å‡åˆ† (ä¾‹å¦‚ "Açš„50ã€Bçš„50")
        // é€™è£¡æˆ‘å€‘çµ±ä¸€è¦–ç‚ºã€Œè‡ªè¨‚æ¨¡å¼ (CUSTOM)ã€è™•ç†ï¼Œé€™æ¨£æœ€æº–ç¢º
        
        splitMode = "CUSTOM"; // åˆ‡æ›åˆ°æ‰‹è¼¸æ¨¡å¼
        
        // è§£æå­—ä¸²ï¼šå…ˆç”¨ã€Œã€ã€åˆ†å‰²ï¼Œå†è§£æã€Œçš„ã€
        const parts = splitText.split("ã€");
        
        // å…ˆæ¸…ç©ºæ‰€æœ‰äººçš„é‡‘é¡
        settings.members.forEach((m, i) => document.getElementById(`amt-${i}`).value = "");

        parts.forEach(part => {
           // part å¯èƒ½æ˜¯ "Açš„10"
           const [name, amount] = part.split("çš„");
           if (name && amount) {
              // æ‰¾åˆ°é€™å€‹åå­—å°æ‡‰çš„ index
              const idx = settings.members.indexOf(name);
              if (idx !== -1) {
                 document.getElementById(`amt-${idx}`).value = parseFloat(amount);
              }
           }
        });

     } else {
        // å…¶ä»–æœªçŸ¥æƒ…æ³ï¼Œç¶­æŒé è¨­æˆ–åªé¡¯ç¤ºåœ¨å‚™è¨»
        if(splitText) document.getElementById('note-input').value += ` (åŸåˆ†å¸³: ${splitText})`;
     }
     
     // æœ€å¾Œè¨˜å¾—é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼Œæ•¸å€¼æ‰æœƒé¡¯ç¤ºå‡ºä¾†
     renderSplitList();
  }
// --- è‡ªè£½è¨ˆç®—æ©Ÿé‚è¼¯ ---
  
  // é–‹å•Ÿè¨ˆç®—æ©Ÿ
  function openCalculator() {
    document.getElementById('custom-calculator').classList.add('show');
    // å¦‚æœç›®å‰é‡‘é¡æ˜¯ 0ï¼Œå…ˆæ¸…ç©ºæ–¹ä¾¿è¼¸å…¥
    const el = document.getElementById('amount-input');
    if(el.value === "0") el.value = "";
  }

  // é—œé–‰è¨ˆç®—æ©Ÿ (é»æ“ŠèƒŒæ™¯æˆ–å…¶ä»–åœ°æ–¹æ™‚å¯ä»¥å‘¼å«ï¼Œé€™è£¡å…ˆåšåœ¨ OK éµè£¡)
  function closeCalculator() {
    document.getElementById('custom-calculator').classList.remove('show');
  }

  // è™•ç†æŒ‰éµè¼¸å…¥
  function calcAppend(val) {
    const el = document.getElementById('amount-input');
    
    if (val === 'AC') {
      el.value = "";
    } else if (val === 'DEL') {
      el.value = el.value.slice(0, -1);
    } else {
      // é¿å…é‡è¤‡è¼¸å…¥é‹ç®—ç¬¦è™Ÿ (ç°¡æ˜“é˜²å‘†)
      const lastChar = el.value.slice(-1);
      const isOp = ['+','-','*','/'].includes(val);
      if (isOp && ['+','-','*','/'].includes(lastChar)) {
         el.value = el.value.slice(0, -1) + val; // æ›¿æ›æœ€å¾Œä¸€å€‹ç¬¦è™Ÿ
      } else {
         el.value += val;
      }
    }
  }

// æŒ‰ä¸‹ OKï¼šè¨ˆç®—çµæœä¸¦æ›´æ–°åˆ†å¸³
  function calcDone() {
    const el = document.getElementById('amount-input');
    try {
      if (el.value) {
        // ç§»é™¤å¯èƒ½åœ¨çµå°¾çš„é‹ç®—ç¬¦è™Ÿ (ä¾‹å¦‚ "100+" -> "100")
        let safeValue = el.value.replace(/[+\-*/]*$/, '');
        
        // ä½¿ç”¨ Function åŸ·è¡Œæ•¸å­¸é‹ç®—
        const result = new Function('return ' + safeValue)(); 
        
        // è™•ç†ç„¡é™å¤§æˆ–éæ•¸å­—çš„æƒ…æ³
        if (!isFinite(result) || isNaN(result)) {
            el.value = "0";
        } else {
            // å–å…©ä½å°æ•¸ä¸¦è½‰å›æ•¸å­—ï¼Œé¿å…ç²¾åº¦å•é¡Œ
            el.value = Math.round(result * 100) / 100;
        }
        
        // è§¸ç™¼åŸæœ¬çš„åˆ†å¸³æ›´æ–°é‚è¼¯
        updateSplitMath(); 
      }
    } catch (e) {
      alert("ç®—å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
      el.value = ""; // æ¸…ç©ºéŒ¯èª¤è¼¸å…¥
    }
    
    // âš ï¸ é—œéµï¼šé€™è¡Œä¸€å®šè¦åœ¨æœ€å¾Œé¢ï¼Œè² è²¬é—œé–‰è¨ˆç®—æ©Ÿé¢æ¿
    closeCalculator();
  }
</script>
</body>
</html>
