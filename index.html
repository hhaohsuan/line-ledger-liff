<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å¸³æœ¬è¨­å®š</title>
  <style>
    :root { --primary: #06c755; --bg: #f2f5f8; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); padding: 15px; margin: 0; color: #333; }
    
    /* Loading é®ç½© */
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; }
    h2 { color: var(--primary); text-align: center; margin: 0 0 5px 0; }
    h3 { font-size: 1rem; border-left: 4px solid var(--primary); padding-left: 8px; margin-top: 20px; }
    
    input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 5px; -webkit-appearance: none;}
    
    .tag-box { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .tag { background: #eefcf3; padding: 6px 12px; border-radius: 20px; border: 1px solid #ccebd4; display: flex; align-items: center; font-size: 14px; }
    .tag .rm { color: #ff5e5e; margin-left: 8px; cursor: pointer; font-weight: bold; }
    
    .add-row { display: flex; gap: 5px; }
    .btn-add { background: #eee; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-size: 20px; color: #666;}
    .btn-save { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: none; box-shadow: 0 4px 10px rgba(6,199,85,0.3); }
    .btn-save:disabled { background: #ccc; box-shadow: none; }
    
    .hint { font-size: 12px; color: #999; margin-bottom: 5px; }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p id="loading-text" style="margin-top:15px; color:#666;">æ­£åœ¨é€£ç·š LIFF...</p>
</div>

<div class="card" id="main-ui">
  <h2>âš™ï¸ å¸³æœ¬è¨­å®š</h2>
  <div id="ledger-title" style="text-align:center; color:#888; margin-bottom:20px;">...</div>

  <h3>æˆå“¡ <span style="font-size:12px; font-weight:normal; color:#aaa">(æœ€å¤š13äºº)</span></h3>
  <div id="members-list" class="tag-box"></div>
  <div class="add-row">
    <input type="text" id="new-member" placeholder="è¼¸å…¥åå­—">
    <button type="button" class="btn-add" onclick="add('members-list', 'new-member', 13)">ï¼‹</button>
  </div>

  <h3>å¹£åˆ¥ & åŒ¯ç‡</h3>
  <div style="display:flex; gap:10px;">
     <div style="flex:1"><input type="text" id="currency" placeholder="å¹£åˆ¥ (å¦‚ TWD)"></div>
     <div style="flex:1"><input type="number" id="rate" step="0.0001" placeholder="åŒ¯ç‡"></div>
  </div>
  <div class="hint">* è¼¸å…¥ã€Œæ³°éŠ–ã€è‡ªå‹•è½‰ THB</div>

  <h3>ä»˜æ¬¾æ–¹å¼ <span style="font-size:12px; font-weight:normal; color:#aaa">(æœ€å¤š6ç¨®)</span></h3>
  <div id="payments-list" class="tag-box"></div>
  <div class="add-row">
    <input type="text" id="new-payment" placeholder="å¦‚ å¯Œé‚¦Jå¡">
    <button type="button" class="btn-add" onclick="add('payments-list', 'new-payment', 6)">ï¼‹</button>
  </div>

  <h3>é …ç›®åˆ†é¡ <span style="font-size:12px; font-weight:normal; color:#aaa">(æœ€å¤š8ç¨®)</span></h3>
  <div id="categories-list" class="tag-box"></div>
  <div class="add-row">
    <input type="text" id="new-category" placeholder="å¦‚ äº¤é€š, ä½å®¿">
    <button type="button" class="btn-add" onclick="add('categories-list', 'new-category', 8)">ï¼‹</button>
  </div>
</div>

<button class="btn-save" id="save-btn" onclick="save()">ğŸ’¾ å„²å­˜è¨­å®š</button>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ğŸ”´ é€™è£¡è«‹å¡«å…¥æ­£ç¢ºè³‡è¨Š
  const MY_LIFF_ID = "2009010836-1OaNzGM2"; 
  // ğŸ‘‡ è«‹å‹™å¿…ç¢ºèªé€™è£¡æ˜¯ä½  GAS éƒ¨ç½²å¾Œæ‹¿åˆ°çš„ /exec ç¶²å€
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwgI2bbO-8SU94pv-G7BU2MBHS2j6BjzTxFgC3YcX0bv0KLHROsi8mRaJ3FiuiefMB1/exec"; 

  var store = { m: [], p: [], c: [] };
  var currentUserId = "";

  window.onload = function() {
    // é¡¯ç¤ºé™¤éŒ¯è¨Šæ¯
    document.getElementById('loading-text').innerText = "å•Ÿå‹• LIFF...";
    
    liff.init({ liffId: MY_LIFF_ID })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          document.getElementById('loading-text').innerText = "æ­£åœ¨è®€å– Google Sheet...";
          fetchData(currentUserId);
        });
      })
      .catch(err => {
         alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
         document.getElementById('loading-text').innerText = "éŒ¯èª¤: " + err;
      });
  };

  function fetchData(uid) {
    // ğŸ”¥ ä¿®æ­£é‡é» 1: ä½¿ç”¨ text/plain é¿é–‹ CORS æª¢æŸ¥
    fetch(GAS_API_URL, {
      method: 'POST',
      redirect: "follow", // âœ… å¿…é ˆåŠ é€™å€‹ï¼Œå› ç‚º GAS æœƒè½‰å€
      headers: {
        "Content-Type": "text/plain;charset=utf-8", // âœ… æ”¹æˆç´”æ–‡å­—
      },
      body: JSON.stringify({ action: 'getSettings', userId: uid })
    })
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        var d = res.data;
        store.m = d.members || [];
        store.p = d.payments || [];
        store.c = d.categories || [];
        
        document.getElementById('ledger-title').innerText = d.ledgerName;
        document.getElementById('currency').value = d.currency;
        document.getElementById('rate').value = d.rate;
        
        render('members-list', store.m);
        render('payments-list', store.p);
        render('categories-list', store.c);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-ui').style.display = 'block';
        document.getElementById('save-btn').style.display = 'block';
      } else {
        alert("è®€å–å¤±æ•—: " + res.error);
      }
    })
    .catch(err => {
      // é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤
      alert("é€£ç·šéŒ¯èª¤ (Fetch): " + err);
      console.error(err);
    });
  }

  function save() {
    var btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";
    
    var currencyInput = document.getElementById('currency').value.trim();
    var map = { "æ³°éŠ–": "THB", "ç¾é‡‘": "USD", "æ—¥å¹£": "JPY", "æ­å…ƒ": "EUR", "éŸ“å…ƒ": "KRW", "æ¸¯å¹£": "HKD", "äººæ°‘å¹£": "CNY", "å°å¹£": "TWD" };
    var finalCurrency = map[currencyInput] || currencyInput.toUpperCase();

    var payload = {
       members: store.m,
       payments: store.p,
       categories: store.c,
       currency: finalCurrency,
       rate: document.getElementById('rate').value
    };

    // ğŸ”¥ ä¿®æ­£é‡é» 2: å„²å­˜æ™‚ä¹Ÿä¸€æ¨£è¦æ”¹
    fetch(GAS_API_URL, {
      method: 'POST',
      redirect: "follow", // âœ… å¿…é ˆåŠ 
      headers: {
        "Content-Type": "text/plain;charset=utf-8", // âœ… å¿…é ˆæ”¹
      },
      body: JSON.stringify({ 
        action: 'saveSettings', 
        userId: currentUserId,
        data: payload
      })
    })
    .then(res => res.json())
    .then(res => {
       if(res.success) {
          alert("âœ… è¨­å®šå·²å„²å­˜ï¼");
          liff.closeWindow();
       } else {
          alert("âŒ å¤±æ•—: " + res.error);
          btn.disabled = false; btn.innerText = "ğŸ’¾ å„²å­˜è¨­å®š";
       }
    })
    .catch(err => {
       alert("å„²å­˜é€£ç·šéŒ¯èª¤: " + err);
       btn.disabled = false; btn.innerText = "ğŸ’¾ å„²å­˜è¨­å®š";
    });
  }

  // --- UI é‚è¼¯ (æ²’è®Š) ---
  function render(id, arr) {
    var el = document.getElementById(id);
    el.innerHTML = "";
    arr.forEach(function(item, i) {
      el.innerHTML += '<div class="tag">' + item + '<span class="rm" onclick="rm(\''+id+'\','+i+')">Ã—</span></div>';
    });
  }
  function add(id, inputId, limit) {
    var input = document.getElementById(inputId);
    var val = input.value.trim();
    var key = (id==='members-list')?'m':(id==='payments-list')?'p':'c';
    if(val && store[key].length < limit) {
       store[key].push(val); render(id, store[key]); input.value = "";
    }
  }
  function rm(id, idx) {
    var key = (id==='members-list')?'m':(id==='payments-list')?'p':'c';
    store[key].splice(idx, 1); render(id, store[key]);
  }
</script>
</body>
</html>

