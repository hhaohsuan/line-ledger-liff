<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æ–°å¢è¨˜å¸³</title>
  <style>
    /* ğŸ¨ æ¨¡ä»¿ Lightsplit é¢¨æ ¼é…è‰² */
    :root { --primary: #46b583; --bg: #f5f5f5; --text: #333; --border: #eee; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); }
    
    /* é ‚éƒ¨å°èˆª */
    .header { background: var(--primary); padding: 15px; color: white; text-align: center; font-weight: bold; font-size: 18px; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
    .header-icon { font-size: 20px; cursor: pointer; }

    /* å€å¡Šæ¨£å¼ */
    .section { background: white; padding: 15px; margin-bottom: 10px; }
    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    .row:last-child { margin-bottom: 0; }
    
    /* è¼¸å…¥æ¡†å„ªåŒ– */
    label { font-size: 12px; color: #888; display: block; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #fff; box-sizing: border-box; -webkit-appearance: none; }
    input:focus, select:focus { border-color: var(--primary); outline: none; }
    
    /* é‡‘é¡èˆ‡å¹£åˆ¥ç‰¹æ®Šæ’ç‰ˆ */
    .amount-group { display: flex; gap: 10px; }
    .currency-select { flex: 1; }
    .amount-input { flex: 2; font-size: 20px; font-weight: bold; color: var(--primary); text-align: right; }

    /* åº•éƒ¨æŒ‰éˆ• */
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); box-sizing: border-box; }
    .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn-save:disabled { background: #ccc; }

    /* è®€å–é®ç½© */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 99; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  </style>
</head>
<body>

<div id="loading">
  <div style="color: var(--primary); font-weight:bold;">è®€å–ä¸­...</div>
</div>

<div class="header">
  <span class="header-icon" onclick="liff.closeWindow()">âœ•</span>
  <span id="page-title">æ–°å¢è¨˜å¸³</span>
  <span class="header-icon" style="opacity:0">âœ•</span>
</div>

<form id="record-form">
  <div class="section">
    <label>æ—¥æœŸ & æ™‚é–“</label>
    <input type="datetime-local" id="date-input" required>
  </div>

  <div class="section">
    <div class="row">
      <div style="flex:1">
        <label>åˆ†é¡</label>
        <select id="category-select"><option>è¼‰å…¥ä¸­...</option></select>
      </div>
      <div style="flex:2">
        <label>å“é …åç¨±</label>
        <input type="text" id="item-input" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€æ©Ÿç¥¨" required>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="amount-group">
      <div class="currency-select">
        <label>å¹£åˆ¥</label>
        <select id="currency-select" onchange="updateRatePlaceholder()">
           </select>
      </div>
      <div class="amount-input">
        <label>é‡‘é¡</label>
        <input type="number" id="amount-input" step="0.01" placeholder="0" required>
      </div>
    </div>
    <div id="rate-row" style="margin-top:10px; display:none;">
       <label>åŒ¯ç‡ (é è¨­: <span id="default-rate">1</span>)</label>
       <input type="number" id="rate-input" step="0.0001" placeholder="ç•™ç©ºå‰‡ä½¿ç”¨é è¨­åŒ¯ç‡">
    </div>
  </div>

  <div class="section">
    <div class="row">
      <div style="flex:1">
        <label>èª°å…ˆä»˜éŒ¢ (ä»˜æ¬¾äºº)</label>
        <select id="payer-select"></select>
      </div>
      <div style="flex:1">
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="payment-select"></select>
      </div>
    </div>
  </div>

  <div class="section">
    <label>å¦‚ä½•åˆ† (åˆ†å¸³)</label>
    <select id="split-method" onchange="onSplitChange()">
      <option value="å‡åˆ†">å‡åˆ† (é è¨­)</option>
      <option value="è‡ªè¨‚">è‡ªè¨‚æè¿°...</option>
      <option value="ä¸å¡«">ä¸å¡« (ä¸åˆ†å¸³)</option>
    </select>
    <input type="text" id="split-detail" placeholder="ä¾‹å¦‚ï¼šè»’çš„7ã€ç¿çš„12" style="display:none; margin-top:10px;">
  </div>

  <div class="section">
    <label>å‚™è¨»</label>
    <textarea id="note-input" rows="3" placeholder="å‚™è¨»..."></textarea>
  </div>

  <div style="height: 20px;"></div> <div class="footer">
    <button type="button" class="btn-save" id="save-btn" onclick="submitForm()">ç¢ºèªå„²å­˜</button>
  </div>
</form>

<input type="hidden" id="edit-row-index" value="">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ğŸ”´ è¨­å®šå€
  const LIFF_ID = "2009010836-bedIz9Jo"; // è«‹å¡«å…¥é€™å€‹é é¢å°æ‡‰çš„ LIFF ID
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwgI2bbO-8SU94pv-G7BU2MBHS2j6BjzTxFgC3YcX0bv0KLHROsi8mRaJ3FiuiefMB1/exec"; // è«‹å¡«å…¥ä½ çš„ GAS ç¶²å€

  let currentSettings = {};
  let userId = "";

  window.onload = function() {
    // 1. åˆå§‹åŒ– LIFF
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) { liff.login(); return; }
      
      liff.getProfile().then(profile => {
        userId = profile.userId;
        initPage(); // é–‹å§‹è¼‰å…¥è³‡æ–™
      });
    });
  };

  async function initPage() {
    // è¨­å®šé è¨­æ™‚é–“ç‚ºç¾åœ¨
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('date-input').value = now.toISOString().slice(0,16);

    // æª¢æŸ¥ç¶²å€æœ‰æ²’æœ‰åƒæ•¸ (å¦‚æœæ˜¯ã€Œä¿®æ”¹ã€æ¨¡å¼ï¼Œæœƒæœ‰ ?row=xxx)
    const urlParams = new URLSearchParams(window.location.search);
    const editRow = urlParams.get('row');

    // å‘¼å« GAS å–å¾—è¨­å®š (å¦‚æœæ˜¯ä¿®æ”¹ï¼Œé †ä¾¿å–å¾—è©²ç­†è³‡æ–™)
    const action = editRow ? 'getEditData' : 'getSettings';
    
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: action, userId: userId, row: editRow })
      }).then(r => r.json());

      if (res.success) {
        // 1. å¡«å…¥ä¸‹æ‹‰é¸å–® (æˆå“¡ã€åˆ†é¡ã€ä»˜æ¬¾æ–¹å¼)
        renderSelect('payer-select', res.data.members);
        renderSelect('category-select', res.data.categories);
        renderSelect('payment-select', res.data.payments);
        
        // å¹£åˆ¥æ¯”è¼ƒç‰¹åˆ¥ï¼Œè¦åŒ…å«é è¨­åŒ¯ç‡
        renderCurrency(res.data.currency, res.data.rate);
        currentSettings = res.data; // å­˜èµ·ä¾†å‚™ç”¨

        // 2. å¦‚æœæ˜¯ã€Œä¿®æ”¹æ¨¡å¼ã€ï¼Œå›å¡«è³‡æ–™
        if (editRow && res.record) {
          fillForm(res.record);
          document.getElementById('page-title').innerText = "ç·¨è¼¯è¨˜å¸³";
          document.getElementById('edit-row-index').value = editRow;
        } else {
            // æ–°å¢æ¨¡å¼ï¼šé è¨­ä»˜æ¬¾äººç‚ºç¬¬ä¸€ä½æˆå“¡
           if(res.data.members.length > 0) document.getElementById('payer-select').value = res.data.members[0];
        }

        document.getElementById('loading').style.display = 'none';
      } else {
        alert("è¼‰å…¥å¤±æ•—: " + res.error);
      }
    } catch (e) {
      alert("é€£ç·šéŒ¯èª¤: " + e);
    }
  }

  // è¼”åŠ©ï¼šæ¸²æŸ“ä¸‹æ‹‰é¸å–®
  function renderSelect(id, list) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    (list || []).forEach(item => {
      el.innerHTML += `<option value="${item}">${item}</option>`;
    });
  }

  // è¼”åŠ©ï¼šæ¸²æŸ“å¹£åˆ¥èˆ‡åŒ¯ç‡
  function renderCurrency(defaultCurr, defaultRate) {
    const el = document.getElementById('currency-select');
    // é è¨­å¹£åˆ¥æ”¾ç¬¬ä¸€å€‹
    const options = [defaultCurr, "TWD", "JPY", "USD", "EUR", "THB", "CNY", "KRW"];
    // å»é™¤é‡è¤‡
    const unique = [...new Set(options)];
    
    el.innerHTML = unique.map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('default-rate').innerText = defaultRate;
  }

  // UIäº’å‹•ï¼šåˆ‡æ›å¹£åˆ¥æ™‚é¡¯ç¤º/éš±è—åŒ¯ç‡æ¡†
  function updateRatePlaceholder() {
    const val = document.getElementById('currency-select').value;
    const rateRow = document.getElementById('rate-row');
    if (val === 'TWD') {
       rateRow.style.display = 'none';
    } else {
       rateRow.style.display = 'block';
    }
  }

  // UIäº’å‹•ï¼šåˆ‡æ›åˆ†å¸³é‚è¼¯
  function onSplitChange() {
    const val = document.getElementById('split-method').value;
    const detailInput = document.getElementById('split-detail');
    if (val === 'è‡ªè¨‚') {
      detailInput.style.display = 'block';
    } else {
      detailInput.style.display = 'none';
      detailInput.value = ""; // æ¸…ç©º
    }
  }

  // ğŸ“ é€å‡ºè¡¨å–®
  function submitForm() {
    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";

    // çµ„åˆåˆ†å¸³å­—ä¸²
    let splitText = "";
    const splitMethod = document.getElementById('split-method').value;
    if (splitMethod === "ä¸å¡«") splitText = "";
    else if (splitMethod === "è‡ªè¨‚") splitText = document.getElementById('split-detail').value;
    else splitText = ""; // å‡åˆ†é€šå¸¸ç•™ç©ºè®“å…¬å¼è™•ç†ï¼Œæˆ–å¡«å…¥"å‡åˆ†"

    const payload = {
      date: document.getElementById('date-input').value,
      category: document.getElementById('category-select').value,
      item: document.getElementById('item-input').value,
      amount: document.getElementById('amount-input').value,
      currency: document.getElementById('currency-select').value,
      rate: document.getElementById('rate-input').value, // å¦‚æœç•™ç©ºå¾Œç«¯æœƒè™•ç†
      payer: document.getElementById('payer-select').value,
      payment: document.getElementById('payment-select').value,
      split: splitText,
      note: document.getElementById('note-input').value,
      row: document.getElementById('edit-row-index').value // å¦‚æœæœ‰å€¼ä»£è¡¨æ˜¯ä¿®æ”¹
    };

    fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveTransaction', userId: userId, data: payload })
    })
    .then(r => r.json())
    .then(res => {
       if (res.success) {
          liff.closeWindow(); // é—œé–‰è¦–çª—ï¼ŒLINE æœƒé¡¯ç¤º Flex Message
       } else {
          alert("å„²å­˜å¤±æ•—: " + res.error);
          btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜";
       }
    })
    .catch(err => {
       alert("éŒ¯èª¤: " + err);
       btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜";
    });
  }

  // ä¿®æ”¹æ¨¡å¼ï¼šå›å¡«è³‡æ–™
  function fillForm(record) {
     // record æ ¼å¼é æœŸç‚ºå¾Œç«¯æ•´ç†å¥½çš„ JSON
     // æ—¥æœŸæ ¼å¼è½‰æ›
     try {
       const d = new Date(record.date);
       d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
       document.getElementById('date-input').value = d.toISOString().slice(0,16);
     } catch(e) {}

     document.getElementById('item-input').value = record.item;
     document.getElementById('category-select').value = record.category;
     document.getElementById('amount-input').value = record.amount;
     document.getElementById('currency-select').value = record.currency;
     document.getElementById('payment-select').value = record.method;
     document.getElementById('payer-select').value = record.payer;
     document.getElementById('note-input').value = record.note;
     
     if (record.rate && record.rate != 1) {
        document.getElementById('rate-input').value = record.rate;
     }

     // åˆ†å¸³å›å¡«é‚è¼¯
     if (record.split) {
        document.getElementById('split-method').value = "è‡ªè¨‚";
        document.getElementById('split-detail').style.display = "block";
        document.getElementById('split-detail').value = record.split;
     }
     
     updateRatePlaceholder();
  }
</script>
</body>
</html>
