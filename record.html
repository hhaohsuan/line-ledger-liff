<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è¨˜ä¸€ç­†</title>
  <style>
    /* âœ… å…¨åŸŸè¨­å®šï¼šè§£æ±ºè¼¸å…¥æ¡†å‡¸å‡ºå»çš„å•é¡Œ */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    /* --- ğŸ¨ ä¸»é¡Œè®Šæ•¸ç³»çµ± --- */
    :root {
      /* é è¨­é¡è‰² (ç¶ è‰²) */
      --primary: #06c755;
      --primary-light: #e8f9ee;
      
      /* é è¨­èƒŒæ™¯ (äº®è‰²) */
      --bg: #f7f9fc;
      --card-bg: #ffffff;
      --text: #333333;
      --text-sub: #888888;
      --border: #e1e5eb;
      --input-bg: #f9f9f9;
      --red: #ff4b4b;
    }

    /* ğŸ”µ è—è‰²ä¸»é¡Œ */
    body[data-color="blue"] { --primary: #007bff; --primary-light: #e6f2ff; }
    /* ğŸŸ£ ç´«è‰²ä¸»é¡Œ */
    body[data-color="purple"] { --primary: #8e44ad; --primary-light: #f4ecf7; }
    /* ğŸŸ  æ©˜è‰²ä¸»é¡Œ */
    body[data-color="orange"] { --primary: #ff9800; --primary-light: #fff3e0; }
    /* ğŸ©· ç²‰è‰²ä¸»é¡Œ */
    body[data-color="pink"] { --primary: #ff6b81; --primary-light: #ffeef0; }

    /* ğŸŒ™ æš—é»‘æ¨¡å¼ (ç–ŠåŠ åœ¨é¡è‰²ä¹‹ä¸Š) */
    body.dark-mode {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e0e0e0;
      --text-sub: #aaaaaa;
      --border: #333333;
      --input-bg: #2c2c2c;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); transition: background 0.3s, color 0.3s; }
    
    /* Header */
    .header { background: var(--card-bg); padding: 15px 20px; box-shadow: 0 1px 0 var(--border); position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
    .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    
    /* è¨­å®šæŒ‰éˆ•å€å¡Š */
    .settings-area { display: flex; gap: 10px; align-items: center; }
    .theme-select { padding: 5px; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 14px; outline: none; }
    .icon-btn { font-size: 20px; cursor: pointer; line-height: 1; padding: 5px; border-radius: 50%; background: transparent; border: none; color: var(--text-sub); }

    .container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: background 0.3s; }
    
    label { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; display: block; font-weight: 500; }
    
    .input-group { position: relative; display: flex; align-items: center; }
    input, select, textarea { 
        width: 100%; padding: 12px; font-size: 16px; 
        border: 1px solid var(--border); border-radius: 12px; 
        background: var(--input-bg); color: var(--text);
        transition: all 0.2s; appearance: none;
    }
    input:focus, select:focus, textarea:focus { background: var(--card-bg); border-color: var(--primary); outline: none; }
    
    #amount-input { font-size: 28px; font-weight: bold; color: var(--primary); text-align: right; padding-right: 15px; }
    .calc-icon { position: absolute; left: 15px; color: #ccc; font-size: 20px; }

    .currency-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
    .c-btn { flex: 1; padding: 10px; text-align: center; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: 500; color: var(--text-sub); background: var(--card-bg); transition: 0.2s; }
    .c-btn.active { background: var(--primary-light); color: var(--primary); border-color: var(--primary); font-weight: bold; }

    .loading-spin { display: none; width: 16px; height: 16px; border: 2px solid #ddd; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* åˆ†å¸³ä»‹é¢å„ªåŒ– */
    .split-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px; }
    .split-tools { display: flex; gap: 8px; font-size: 12px; }
    .tool-btn { cursor: pointer; font-weight: 600; padding: 6px 10px; background: var(--primary-light); color: var(--primary); border-radius: 6px; font-size: 12px; }

    .split-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .split-row:last-child { border-bottom: none; }
    .user-info { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; overflow: hidden; }
    .user-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); }

    .split-input-group { position: relative; width: 100px; }
    .split-amount { 
      width: 100% !important; text-align: right; padding: 8px !important; font-size: 15px !important; 
      border: 1px solid var(--border) !important; border-radius: 8px;
      background: var(--input-bg) !important; color: var(--text);
    }
    .split-amount:focus { background: var(--card-bg) !important; border-color: var(--primary) !important; }
    .split-amount::placeholder { color: var(--text-sub); font-style: italic; }

    .checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; background: var(--card-bg); }
    .checkbox.checked { background: var(--primary); border-color: var(--primary); }
    .checkbox.checked::after { content: 'âœ”'; color: white; font-size: 14px; }
    
    .avatar { width: 32px; height: 32px; background: var(--input-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text-sub); font-size: 13px; flex-shrink: 0; }

    /* Footer å›ºå®šåº•éƒ¨ */
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: var(--card-bg); border-top: 1px solid var(--border); display: flex; z-index: 900; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
    .btn-main { width: 100%; flex: 1; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: 0.2s; }
    .btn-main:active { transform: scale(0.98); }

    .split-summary { text-align: center; margin-bottom: 10px; font-size: 14px; color: var(--text); background: var(--primary-light); padding: 8px; border-radius: 8px; display: flex; justify-content: space-between; }
    .status-ok { color: var(--primary); font-weight: bold; }
    .status-err { color: var(--red); font-weight: bold; }

    /* è¨ˆç®—æ©Ÿæ¨£å¼ (æš—é»‘æ¨¡å¼é©é…) */
    .calc-overlay { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--bg); border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 1000; padding: 15px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
    .calc-overlay.show { bottom: 0; }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: 10px; height: 380px; }
    .calc-btn { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; font-size: 24px; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    .calc-btn:active { background: var(--input-bg); }
    .btn-op { background: #ff9f0a; color: white; border: none; }
    .btn-eq { background: var(--primary); color: white; border: none; grid-row: span 2; }
    .btn-ac { background: var(--input-bg); color: var(--text); font-weight: 500; }
    .input-readonly { cursor: pointer; background: var(--card-bg) !important; color: var(--primary); caret-color: transparent; }
  </style>
</head>
<body>

<div class="header">
  <div class="icon-btn" onclick="liff.closeWindow()">âœ•</div>
  <h1>æ–°å¢è¨˜å¸³</h1>
  <div class="settings-area">
      <select id="theme-select" class="theme-select" onchange="changeColor(this.value)">
          <option value="green">ç¶ è‰²</option>
          <option value="blue">è—è‰²</option>
          <option value="purple">ç´«è‰²</option>
          <option value="orange">æ©˜è‰²</option>
          <option value="pink">ç²‰è‰²</option>
      </select>
      <button class="icon-btn" onclick="toggleDarkMode()">ğŸŒ™</button>
  </div>
</div>

<div class="container">
  
  <div class="card">
    <label>æ—¥æœŸ & æ™‚é–“</label>
    <input type="datetime-local" id="date-input">
  </div>

  <div class="card">
    <label>å“é … <span id="predict-loading" class="loading-spin"></span></label>
    <input type="text" id="item-input" placeholder="è¼¸å…¥å…§å®¹..." onblur="predictCategory()">
    <label style="margin-top: 15px;">åˆ†é¡</label>
    <select id="category-select"><option>è¼‰å…¥ä¸­...</option></select>
  </div>

  <div class="card">
    <div class="currency-toggle" id="currency-box"></div>

    <label>é‡‘é¡</label>
    <div class="input-group">
      <span class="calc-icon">ï¹©</span>
      <input type="text" id="amount-input" class="input-readonly" placeholder="0" 
             readonly onclick="openCalculator()">
    </div>

    <div id="twd-convert-row" style="margin-top: 15px; display: none;">
      <label>ğŸ’³ åˆ·å¡é€šçŸ¥å°å¹£é‡‘é¡ (é¸å¡«)</label>
      <input type="number" id="amount-twd-input" placeholder="å¯¦éš›æ‰£æ¬¾å°å¹£é‡‘é¡" style="background:#fff8e1; border-color:#ffe082; color:#333;">
    </div>
  </div>

  <div class="card">
    <label style="margin-bottom:15px; color:var(--primary); font-size:15px; border-bottom:1px solid var(--border); padding-bottom:5px;">
        ä»˜æ¬¾èˆ‡åˆ†å¸³è©³æƒ…
    </label>
    
    <div style="display:flex; gap:12px; margin-bottom: 5px;">
      <div style="flex:1">
        <label>å…ˆä»˜éŒ¢çš„äºº</label>
        <select id="payer-select"></select>
      </div>
      <div style="flex:1">
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="payment-select"></select>
      </div>
    </div>

    <div class="split-header">
        <label style="margin:0">å¦‚ä½•åˆ†å¸³</label>
        <div class="split-tools">
           <div class="tool-btn" onclick="toggleSelectAll()">å…¨é¸/å–æ¶ˆ</div>
           <div class="tool-btn" onclick="toggleSplitMode()">åˆ‡æ›æ‰‹å‹•</div>
        </div>
    </div>
    
    <div class="split-summary">
      <span>ç¸½é¡: <span id="total-display">0</span></span>
      <span id="remainder-display" class="status-ok">åˆ†é…: è‡ªå‹•è¨ˆç®—</span>
    </div>

    <div id="split-list"></div>
    <textarea id="note-input" rows="2" placeholder="å‚™è¨»..." style="margin-top:15px;"></textarea>
  </div>

</div>

<div id="custom-calculator" class="calc-overlay">
     <div class="calc-grid">
        <button class="calc-btn btn-ac" onclick="calcAppend('AC')">AC</button>
        <button class="calc-btn btn-ac" onclick="calcAppend('DEL')">âŒ«</button>
        <button class="calc-btn btn-op" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn btn-op" onclick="calcAppend('*')">Ã—</button>

        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn btn-op" onclick="calcAppend('-')">-</button>

        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn btn-op" onclick="calcAppend('+')">+</button>

        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        
        <button class="calc-btn btn-eq" style="grid-row: span 2;" onclick="calcDone()">OK</button>

        <button class="calc-btn" style="grid-column: span 2" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
     </div>
</div>

<div class="footer">
  <button class="btn-main" id="save-btn" onclick="save()">ç¢ºèªå„²å­˜</button>
</div>

<input type="hidden" id="edit-row-index">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ğŸ”´ è«‹å¡«å…¥ä½ çš„è³‡è¨Š
  const LIFF_ID = "2009010836-bedIz9Jo"; 
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwgI2bbO-8SU94pv-G7BU2MBHS2j6BjzTxFgC3YcX0bv0KLHROsi8mRaJ3FiuiefMB1/exec";

  let settings = { members: [], categories: [], payments: [], currency: "TWD" };
  let currentCurrency = "TWD";
  let splitMode = "EVEN"; // "EVEN" (å‹¾é¸) æˆ– "CUSTOM" (æ‰‹è¼¸)
  let userId = "";

  window.onload = function() {
    // 1. åˆå§‹åŒ–æ™‚é–“ (è§£æ±ºæ™‚å€å•é¡Œ)
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('date-input').value = now.toISOString().slice(0,16);

    // 2. è®€å–å„²å­˜çš„ä¸»é¡Œ
    initTheme();

    // 3. LIFF åˆå§‹åŒ–
    liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        liff.getProfile().then(profile => {
            userId = profile.userId;
            loadData();
        });
    });
  };

  // --- ğŸ¨ ä¸»é¡Œæ§åˆ¶é‚è¼¯ ---
  function initTheme() {
      const savedColor = localStorage.getItem('app-color') || 'green';
      const savedDark = localStorage.getItem('app-dark') === 'true';
      
      // å¥—ç”¨é¡è‰²
      document.body.setAttribute('data-color', savedColor);
      document.getElementById('theme-select').value = savedColor;
      
      // å¥—ç”¨æš—é»‘æ¨¡å¼
      if (savedDark) document.body.classList.add('dark-mode');
  }

  function changeColor(color) {
      document.body.setAttribute('data-color', color);
      localStorage.setItem('app-color', color);
  }

  function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('app-dark', isDark);
  }

  async function loadData() {
    const urlParams = new URLSearchParams(window.location.search);
    const editRow = urlParams.get('row');
    const action = editRow ? 'getEditData' : 'getSettings';

    try {
      const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action, userId, row: editRow }) }).then(r=>r.json());
      if(res.success) {
         settings = res.data;
         renderSelect('category-select', settings.categories);
         renderSelect('payer-select', settings.members);
         renderSelect('payment-select', settings.payments);
         renderCurrencyUI(settings.currency);
         renderSplitList();
         
         if(editRow && res.record) fillForm(res.record);
         else {
            if(settings.members.length > 0) document.getElementById('payer-select').value = settings.members[0];
            toggleSelectAll(true); // é è¨­å…¨é¸
         }
      }
    } catch(e) { alert("è¼‰å…¥éŒ¯èª¤: " + e); }
  }

  function renderSelect(id, list) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    (list||[]).forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
  }

  function renderCurrencyUI(mainCurrency) {
    const box = document.getElementById('currency-box');
    box.innerHTML = "";
    const btn1 = document.createElement('div');
    btn1.className = "c-btn active"; btn1.innerText = mainCurrency;
    btn1.onclick = () => setCurrency(mainCurrency, btn1);
    box.appendChild(btn1);
    currentCurrency = mainCurrency;

    if (mainCurrency !== "TWD") {
        const btn2 = document.createElement('div');
        btn2.className = "c-btn"; btn2.innerText = "TWD";
        btn2.onclick = () => setCurrency("TWD", btn2);
        box.appendChild(btn2);
    }
    updateTwdInputVisibility();
  }

  function setCurrency(code, btnElement) {
    currentCurrency = code;
    document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');
    updateTwdInputVisibility();
  }

  function updateTwdInputVisibility() {
    const show = (settings.currency !== "TWD" && currentCurrency !== "TWD");
    document.getElementById('twd-convert-row').style.display = show ? 'block' : 'none';
  }

  async function predictCategory() {
    const item = document.getElementById('item-input').value.trim();
    if(!item) return;
    document.getElementById('predict-loading').style.display = 'inline-block';
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'predictCategory', item: item, categories: settings.categories })
      }).then(r=>r.json());
      if(res.success && res.category) document.getElementById('category-select').value = res.category;
    } catch(e) {}
    finally { document.getElementById('predict-loading').style.display = 'none'; }
  }

  // --- åˆ†å¸³æ ¸å¿ƒé‚è¼¯ ---
  function renderSplitList() {
    const list = document.getElementById('split-list');
    const oldHtml = list.innerHTML;
    list.innerHTML = "";
    
    settings.members.forEach((member, idx) => {
      let isChecked = true;
      let existingVal = "";

      if (oldHtml) {
         const oldChk = document.getElementById(`chk-${idx}`);
         const oldInp = document.getElementById(`amt-${idx}`);
         if (oldChk) isChecked = oldChk.classList.contains('checked');
         if (oldInp) existingVal = oldInp.value;
      }

      const row = document.createElement('div');
      row.className = "split-row";
      const initial = member.substring(0,1);
      const inputClass = existingVal ? "split-amount has-value" : "split-amount";

      row.innerHTML = `
        <div class="user-info" onclick="toggleSplitMember(${idx})">
           <div class="checkbox ${isChecked?'checked':''}" id="chk-${idx}"></div>
           <div class="avatar">${initial}</div>
           <div class="user-name">${member}</div>
        </div>
        <div class="split-input-group">
           <input type="number" class="${inputClass}" id="amt-${idx}" 
                  placeholder="0" value="${existingVal}" 
                  oninput="onSplitInput(${idx})" onclick="this.select()">
        </div>
      `;
      list.appendChild(row);
    });
    updateSplitMath();
  }

  function toggleSplitMode() {
    splitMode = splitMode === "EVEN" ? "CUSTOM" : "EVEN";
    renderSplitList();
  }

  function toggleSplitMember(idx) {
    if (splitMode !== "EVEN") return; // æ‰‹å‹•æ¨¡å¼ä¸çµ¦å‹¾
    const chk = document.getElementById(`chk-${idx}`);
    chk.classList.toggle('checked');
    
    if (!chk.classList.contains('checked')) {
        const inp = document.getElementById(`amt-${idx}`);
        inp.value = "";
        inp.classList.remove('has-value');
    }
    updateSplitMath();
  }

  function onSplitInput(idx) {
    const inp = document.getElementById(`amt-${idx}`);
    const chk = document.getElementById(`chk-${idx}`);
    
    if (inp.value !== "") {
        chk.classList.add('checked');
        inp.classList.add('has-value');
    } else {
        inp.classList.remove('has-value');
    }
    updateSplitMath();
  }

  function toggleSelectAll(forceSelect = null) {
    if (splitMode !== "EVEN") return;

    const allChecks = document.querySelectorAll('.checkbox');
    let shouldSelectAll = true;
    if (forceSelect === null) {
       const allChecked = Array.from(allChecks).every(c => c.classList.contains('checked'));
       shouldSelectAll = !allChecked;
    } else {
       shouldSelectAll = forceSelect;
    }

    allChecks.forEach((c, i) => {
       if(shouldSelectAll) c.classList.add('checked');
       else {
           c.classList.remove('checked');
           const inp = document.getElementById(`amt-${i}`);
           inp.value = "";
           inp.classList.remove('has-value');
       }
    });
    updateSplitMath();
  }

  function resetSplit() {
    settings.members.forEach((m, i) => {
       document.getElementById(`chk-${i}`).classList.add('checked');
       const inp = document.getElementById(`amt-${i}`);
       inp.value = "";
       inp.classList.remove('has-value');
    });
    splitMode = "EVEN";
    updateSplitMath();
  }

  function updateSplitMath() {
    const total = parseFloat(document.getElementById('amount-input').value) || 0;
    document.getElementById('total-display').innerText = total;

    let manualSum = 0;
    let autoCount = 0;

    settings.members.forEach((m, i) => {
       const chk = document.getElementById(`chk-${i}`);
       const inp = document.getElementById(`amt-${i}`);
       const isChecked = chk.classList.contains('checked');
       const valStr = inp.value;

       if (isChecked) {
           if (valStr !== "") {
               manualSum += parseFloat(valStr);
           } else {
               autoCount++;
           }
       }
    });

    const remaining = total - manualSum;
    const perPerson = autoCount > 0 ? Math.round((remaining / autoCount) * 100) / 100 : 0;

    settings.members.forEach((m, i) => {
       const chk = document.getElementById(`chk-${i}`);
       const inp = document.getElementById(`amt-${i}`);
       const isChecked = chk.classList.contains('checked');
       const valStr = inp.value;

       if (!isChecked) {
           inp.placeholder = "ä¸åƒèˆ‡";
       } else if (valStr === "") {
           inp.placeholder = perPerson;
       }
    });

    const infoEl = document.getElementById('remainder-display');
    if (autoCount === 0) {
        if (Math.abs(remaining) < 0.1) {
            infoEl.innerText = "å®Œç¾åˆ†é…"; infoEl.className = "status-ok";
        } else {
            infoEl.innerText = remaining > 0 ? `é‚„æœ‰ ${remaining} æœªåˆ†` : `è¶…æ”¯ ${Math.abs(remaining)}`;
            infoEl.className = "status-err";
        }
    } else {
        if (remaining < 0) {
            infoEl.innerText = `è¶…æ”¯ ${Math.abs(remaining)} (è«‹ä¿®æ­£)`;
            infoEl.className = "status-err";
        } else {
            infoEl.innerText = `å‰©é¤˜ ${remaining} çµ¦ ${autoCount} äººå‡åˆ†`;
            infoEl.className = "status-ok";
        }
    }
  }

  function getSplitText() {
    let hasManualInput = false;
    let checkedCount = 0;
    const totalMembers = settings.members.length;

    settings.members.forEach((m, i) => {
        if (document.getElementById(`amt-${i}`).value !== "") hasManualInput = true;
        if (document.getElementById(`chk-${i}`).classList.contains('checked')) checkedCount++;
    });

    if (checkedCount === totalMembers && !hasManualInput) return "å‡åˆ†";
    
    if (checkedCount === 1 && !hasManualInput) {
        let name = "";
        settings.members.forEach((m, i) => {
            if (document.getElementById(`chk-${i}`).classList.contains('checked')) name = m;
        });
        return "éƒ½" + name + "çš„";
    }

    if (checkedCount === 0) return null;

    let parts = [];
    settings.members.forEach((m, i) => {
        const chk = document.getElementById(`chk-${i}`);
        const inp = document.getElementById(`amt-${i}`);
        const valStr = inp.value;

        if (chk.classList.contains('checked')) {
            if (valStr !== "") parts.push(`${m}çš„${valStr}`);
        } else {
            parts.push(`${m}çš„0`);
        }
    });
    return parts.join("ã€");
  }

  // âœ… ç·¨è¼¯æ¨¡å¼å›å¡« (ä¿®æ­£æ—¥æœŸæ™‚é–“å›å¡«å•é¡Œ)
  function fillForm(record) {
     document.getElementById('edit-row-index').value = window.location.search.split('row=')[1];
     
     // ğŸ”¥ [é—œéµä¿®æ­£] è™•ç†æ—¥æœŸå›å¡«
     // å¢åŠ é˜²å‘†èˆ‡æ ¼å¼ç›¸å®¹ï¼Œç¢ºä¿åœ¨å„ç€è¦½å™¨(å« iOS)éƒ½èƒ½æ­£ç¢ºé¡¯ç¤ºæ™‚é–“
     if (record.date) {
         try {
             let dateObj = new Date(record.date);
             // å¦‚æœæ ¼å¼éŒ¯èª¤ (Invalid Date)ï¼Œå˜—è©¦æ‰‹å‹•ä¿®æ­£å­—ä¸²æ ¼å¼ (ex: æŠŠç©ºæ ¼æ›æˆ T)
             if (isNaN(dateObj.getTime()) && typeof record.date === 'string') {
                 let cleanDate = record.date.replace(" ", "T").replace(/\//g, "-"); 
                 dateObj = new Date(cleanDate);
             }

             if (!isNaN(dateObj.getTime())) {
                 // ä¿®æ­£æ™‚å€åç§»
                 dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset());
                 document.getElementById('date-input').value = dateObj.toISOString().slice(0,16);
             }
         } catch (e) {
             console.error("æ—¥æœŸè®€å–å¤±æ•—ï¼Œç¶­æŒé¡¯ç¤ºç¾åœ¨æ™‚é–“:", e);
         }
     }

     document.getElementById('item-input').value = record.item;
     document.getElementById('amount-input').value = record.amount;
     document.getElementById('category-select').value = record.category;
     document.getElementById('payment-select').value = record.method;
     document.getElementById('payer-select').value = record.payer;
     document.getElementById('note-input').value = record.note;
     
     const isTwd = (record.currency === 'TWD');
     const btns = document.querySelectorAll('.c-btn');
     if (isTwd && btns.length > 1) setCurrency('TWD', btns[1]);
     else setCurrency(record.currency, btns[0]);

     if(record.amountTWD) document.getElementById('amount-twd-input').value = record.amountTWD;

     // åˆ†å¸³å›å¡«
     const splitText = record.split || "å‡åˆ†"; 
     resetSplit();

     if (splitText === "å‡åˆ†") {
        // å…¨é¸
     } else if (splitText.startsWith("éƒ½") && splitText.endsWith("çš„")) {
        const name = splitText.substring(1, splitText.length - 1);
        toggleSelectAll(false);
        settings.members.forEach((m, i) => {
            if (m === name) document.getElementById(`chk-${i}`).classList.add('checked');
        });
     } else {
        splitMode = "CUSTOM"; 
        const parts = splitText.split("ã€");
        
        settings.members.forEach((m, i) => {
            document.getElementById(`amt-${i}`).value = "";
        });

        parts.forEach(part => {
           const [name, amount] = part.split("çš„");
           if (name && amount !== undefined) {
              const idx = settings.members.indexOf(name);
              if (idx !== -1) {
                  const val = parseFloat(amount);
                  const inp = document.getElementById(`amt-${idx}`);
                  const chk = document.getElementById(`chk-${idx}`);
                  
                  inp.value = val;
                  if (val > 0) inp.classList.add('has-value');
                  chk.classList.add('checked');
              }
           }
        });
     }
     updateSplitMath();
  }

  // --- è¨ˆç®—æ©Ÿ ---
  function openCalculator() {
    document.getElementById('custom-calculator').classList.add('show');
    const el = document.getElementById('amount-input');
    if(el.value === "0") el.value = "";
  }
  function closeCalculator() {
    document.getElementById('custom-calculator').classList.remove('show');
  }
  function calcAppend(val) {
    const el = document.getElementById('amount-input');
    if (val === 'AC') { el.value = ""; } 
    else if (val === 'DEL') { el.value = el.value.slice(0, -1); } 
    else {
      const lastChar = el.value.slice(-1);
      const isOp = ['+','-','*','/'].includes(val);
      if (isOp && ['+','-','*','/'].includes(lastChar)) {
         el.value = el.value.slice(0, -1) + val;
      } else { el.value += val; }
    }
  }
  function calcDone() {
    const el = document.getElementById('amount-input');
    try {
      if (el.value) {
        let safeValue = el.value.replace(/[+\-*/]*$/, '');
        const result = new Function('return ' + safeValue)(); 
        if (!isFinite(result) || isNaN(result)) { el.value = "0"; } 
        else { el.value = Math.round(result * 100) / 100; }
        updateSplitMath(); 
      }
    } catch (e) { alert("ç®—å¼éŒ¯èª¤"); el.value = ""; }
    closeCalculator();
  }

  function save() {
    const splitText = getSplitText();
    const payload = {
      date: document.getElementById('date-input').value,
      item: document.getElementById('item-input').value,
      category: document.getElementById('category-select').value,
      amount: document.getElementById('amount-input').value,
      currency: currentCurrency,
      amountTWD: document.getElementById('amount-twd-input').value || null,
      payer: document.getElementById('payer-select').value,
      method: document.getElementById('payment-select').value, 
      split: splitText,
      note: document.getElementById('note-input').value,
      row: document.getElementById('edit-row-index').value
    };

    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";

    if (liff.isInClient()) {
        fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveTransaction', userId: userId, data: payload, useCache: true })
        })
        .then(r => r.json())
        .then(res => {
           if(res.success) {
               liff.sendMessages([{ type: 'text', text: "âœ… è¨˜å¸³å®Œæˆ" }])
                   .then(() => liff.closeWindow())
                   .catch(err => { console.error(err); liff.closeWindow(); });
           } else { alert("å„²å­˜å¤±æ•—: " + res.error); btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; }
        })
        .catch(e => { alert("ç¶²è·¯éŒ¯èª¤: " + e); btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; });
    } else {
        fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveTransaction', userId: userId, data: payload })
        })
        .then(r=>r.json())
        .then(res => {
           if(res.success) { alert("âœ… å„²å­˜æˆåŠŸï¼"); window.location.reload(); }
           else { alert("å¤±æ•—: " + res.error); btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; }
        })
        .catch(e => { alert("éŒ¯èª¤: " + e); btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; });
    }
  }
</script>
</body>
</html>
