<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¨˜å¸³</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f2f2f7; color: #333; margin: 0; padding: 0; }
    .header { background: #06c755; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; }
    .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px;}
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    label { display: block; font-size: 13px; color: #8e8e93; margin-bottom: 8px; font-weight: 500; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e5e5ea; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; -webkit-appearance: none; }
    input:focus, select:focus, textarea:focus { border-color: #06c755; outline: none; }
    .row { display: flex; gap: 10px; margin-bottom: 15px; }
    .col { flex: 1; }
    .amount-input { font-size: 28px; font-weight: bold; color: #06c755; text-align: right; letter-spacing: 1px; border: 2px solid #06c755; }
    .btn-submit { background: #06c755; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
    .btn-submit:disabled { background: #ccc; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column;}
    .hidden { display: none; }
  </style>
</head>
<body>

<div id="loading" class="loading-overlay">
  <div style="font-size: 40px;">â³</div>
  <div style="margin-top:10px; color:#666;">è®€å–è³‡æ–™ä¸­...</div>
</div>

<div class="header" id="pageTitle">è¨˜å¸³</div>

<div class="container">
  <form id="recordForm">
    <div class="card">
      <div class="row">
         <div class="col" style="flex:1;">
            <label>å¹£åˆ¥</label>
            <input type="text" id="currency" readonly style="background:#f9f9f9; text-align:center; color:#555;">
         </div>
         <div class="col" style="flex:2;">
            <label>ğŸ’° é‡‘é¡</label>
            <input type="number" step="0.01" id="amount" class="amount-input" placeholder="0" required inputmode="decimal">
         </div>
      </div>
      <div class="row">
        <div class="col">
           <label>ğŸ›ï¸ é …ç›®åç¨±</label>
           <input type="text" id="item" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€Grab" required>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>ğŸ“… æ—¥æœŸ</label>
          <input type="date" id="date">
        </div>
        <div class="col">
          <label>â° æ™‚é–“</label>
          <input type="time" id="time">
        </div>
      </div>

      <div class="row">
         <div class="col">
           <label>ğŸ’³ ä»˜æ¬¾æ–¹å¼</label>
           <select id="paymentMethod"></select>
         </div>
         <div class="col">
           <label>ğŸ“‚ åˆ†é¡</label>
           <select id="category"></select>
         </div>
      </div>

      <div class="row">
        <div class="col">
           <label>ğŸ‘¤ å…ˆä»˜éŒ¢çš„äºº</label>
           <select id="payer"></select>
        </div>
      </div>
      
      <div class="row">
        <div class="col">
           <label>ğŸ° å¦‚ä½•åˆ†å¸³ (ç•™ç©º=å‡åˆ†)</label>
           <input type="text" id="split" placeholder="ä¾‹å¦‚ï¼šè»’50, ç¿50">
        </div>
      </div>
    </div>

    <div class="card">
      <label>ğŸ“ å‚™è¨»</label>
      <textarea id="note" rows="2" placeholder="é¸å¡«"></textarea>
    </div>

    <button type="button" class="btn-submit" onclick="submitForm()">å„²å­˜</button>
  </form>
</div>

<script>
  // ğŸ”´ ğŸ”´ ğŸ”´ é‡è¦ï¼šè«‹å¡«å…¥ä½ çš„ GAS éƒ¨ç½²ç¶²å€ (ä»¥ /exec çµå°¾) ğŸ”´ ğŸ”´ ğŸ”´
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwgI2bbO-8SU94pv-G7BU2MBHS2j6BjzTxFgC3YcX0bv0KLHROsi8mRaJ3FiuiefMB1/exec";
  
  // å¡«å…¥ä½ æ–°çš„ LIFF ID (è®“é—œé–‰è¦–çª—åŠŸèƒ½æ›´ç©©å®š)
  const LIFF_ID = "2009010836-bedIz9Jo"; 

  // è§£æç¶²å€åƒæ•¸
  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get('uid');
  const rowId = urlParams.get('row');
  
  if(rowId) document.getElementById('pageTitle').innerText = "âœï¸ ä¿®æ”¹è¨˜å¸³";
  else document.getElementById('pageTitle').innerText = "ğŸ“ æ–°å¢è¨˜å¸³";

  // åˆå§‹åŒ–
  window.onload = async function() {
    // åˆå§‹åŒ– LIFF (ç‚ºäº†èƒ½æ­£å¸¸é—œé–‰è¦–çª—)
    try {
        await liff.init({ liffId: LIFF_ID });
    } catch (err) {
        console.log('LIFF init failed', err);
    }

    if (!userId) { 
        alert("âŒ éŒ¯èª¤ï¼šç¶²å€ç¼ºå°‘ User ID"); 
        document.getElementById('loading').innerHTML = "âŒ ç¶²å€éŒ¯èª¤<br>ç¼ºå°‘ User ID";
        return; 
    }
    
    // 1. è¼‰å…¥è¨­å®š (æˆå“¡ã€åˆ†é¡ç­‰)
    await loadConfig();

    // 2. å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œè¼‰å…¥è©²ç­†è³‡æ–™
    if (rowId) {
       await loadExpenseData();
    } else {
       // æ–°å¢æ¨¡å¼ï¼šè¨­å®šé è¨­æ™‚é–“
       setDefaultTime();
       document.getElementById('loading').classList.add('hidden');
    }
  };

  function setDefaultTime() {
      const now = new Date();
      // èª¿æ•´æ™‚å€ (ç°¡å–®è™•ç†ï¼Œå‡è¨­ä½¿ç”¨è€…åœ¨ç•¶åœ°)
      const local = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
      document.getElementById('date').value = local.toISOString().split('T')[0];
      document.getElementById('time').value = local.toISOString().split('T')[1].slice(0,5);
  }

  // å‘¼å« GAS API å–å¾—è¨­å®š
  async function loadConfig() {
      try {
        const res = await fetch(GAS_API_URL, {
            method: 'POST',
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "getLedgerConfig", userId: userId })
        });
        const json = await res.json();
        
        if (json.success) {
            const data = json.data;
            populateSelect('paymentMethod', data.paymentMethods, data.defaultPayment);
            populateSelect('category', data.categories, "å…¶ä»–");
            populateSelect('payer', data.members, data.members[0]);
            document.getElementById('currency').value = data.defaultCurrency;
        }
      } catch (e) { alert("è¼‰å…¥è¨­å®šå¤±æ•—: " + e); }
  }

  // å‘¼å« GAS API å–å¾—å–®ç­†è³‡æ–™
  async function loadExpenseData() {
      try {
        const res = await fetch(GAS_API_URL, {
            method: 'POST',
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "getExpenseRow", userId: userId, row: rowId })
        });
        const json = await res.json();
        if (json.success) {
            const d = json.data; 
            
            // æ™‚é–“è™•ç†
            const dt = new Date(d[0]);
            const local = new Date(dt.getTime() - (dt.getTimezoneOffset() * 60000));
            document.getElementById('date').value = local.toISOString().split('T')[0];
            document.getElementById('time').value = local.toISOString().split('T')[1].slice(0,5);

            document.getElementById('item').value = d[1];
            document.getElementById('category').value = d[2];
            document.getElementById('amount').value = d[3];
            document.getElementById('currency').value = d[4];
            document.getElementById('paymentMethod').value = d[5];
            document.getElementById('payer').value = d[7];
            document.getElementById('split').value = d[8];
            document.getElementById('note').value = d[9];
        }
        document.getElementById('loading').classList.add('hidden');
      } catch (e) { alert("è®€å–è³‡æ–™å¤±æ•—: " + e); }
  }

  function populateSelect(id, options, defValue) {
      const sel = document.getElementById(id);
      sel.innerHTML = "";
      options.forEach(opt => {
          const el = document.createElement("option");
          el.value = opt;
          el.text = opt;
          if (opt == defValue) el.selected = true;
          sel.appendChild(el);
      });
  }

  // é€å‡ºè¡¨å–®
  async function submitForm() {
      const btn = document.querySelector('.btn-submit');
      const item = document.getElementById('item').value;
      const amount = document.getElementById('amount').value;
      if(!item || !amount) { alert("è«‹å¡«å¯«é …ç›®å’Œé‡‘é¡ï¼"); return; }

      btn.disabled = true;
      btn.innerText = "ğŸ’¾ å„²å­˜ä¸­...";

      const formData = {
          date: document.getElementById('date').value,
          time: document.getElementById('time').value,
          item: item,
          amount: amount,
          currency: document.getElementById('currency').value,
          paymentMethod: document.getElementById('paymentMethod').value,
          category: document.getElementById('category').value,
          payer: document.getElementById('payer').value,
          split: document.getElementById('split').value,
          note: document.getElementById('note').value
      };

      try {
          const res = await fetch(GAS_API_URL, {
              method: 'POST',
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify({ 
                  action: "saveExpense", 
                  userId: userId, 
                  row: rowId, 
                  data: formData 
              })
          });
          const json = await res.json();
          if (json.success) {
              alert("âœ… å„²å­˜æˆåŠŸï¼");
              if (liff.isInClient()) {
                  liff.closeWindow();
              } else {
                  window.close();
              }
          } else {
              alert("âŒ éŒ¯èª¤ï¼š" + json.error);
              btn.disabled = false;
              btn.innerText = "å„²å­˜";
          }
      } catch (e) {
          alert("é€£ç·šå¤±æ•—ï¼š" + e);
          btn.disabled = false;
          btn.innerText = "å„²å­˜";
      }
  }
</script>

</body>
</html>
