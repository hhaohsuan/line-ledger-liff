<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>è¨˜ä¸€ç­†</title>
  <style>
    :root { --primary: #06c755; --bg: #f7f9fc; --text: #333; --border: #e1e5eb; --red: #ff4b4b; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); -webkit-tap-highlight-color: transparent; }
    
    .header { background: white; padding: 15px 20px; box-shadow: 0 1px 0 var(--border); position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    .close-btn { font-size: 24px; color: #888; cursor: pointer; line-height: 1; }

    .container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    
    label { font-size: 13px; color: #888; margin-bottom: 8px; display: block; font-weight: 500; }
    
    .input-group { position: relative; display: flex; align-items: center; }
    input, select, textarea { width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 12px; background: #f9f9f9; box-sizing: border-box; transition: all 0.2s; }
    input:focus, select:focus, textarea:focus { background: white; border-color: var(--primary); outline: none; }
    
    #amount-input { font-size: 28px; font-weight: bold; color: var(--primary); text-align: right; padding-right: 15px; }
    .calc-icon { position: absolute; left: 15px; color: #ccc; font-size: 20px; }

    .currency-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
    .c-btn { flex: 1; padding: 10px; text-align: center; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: 500; color: #666; background: white; }
    .c-btn.active { background: #e8f9ee; color: var(--primary); border-color: var(--primary); font-weight: bold; }

    .loading-spin { display: none; width: 16px; height: 16px; border: 2px solid #ddd; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- åˆ†å¸³ä»‹é¢å„ªåŒ– --- */
    .split-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .split-tools { display: flex; gap: 10px; font-size: 12px; color: var(--primary); }
    .tool-btn { cursor: pointer; font-weight: 600; padding: 4px 8px; background: #e8f9ee; border-radius: 6px; }

    .split-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .split-row:last-child { border-bottom: none; }
    
    /* å·¦å´ï¼šæ ¸å–æ–¹å¡Š + é ­åƒ + åå­— */
    .user-info { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; overflow: hidden; }
    .user-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* å³å´ï¼šé‡‘é¡è¼¸å…¥ */
    .split-input-group { position: relative; width: 110px; }
    .split-amount { 
      width: 100% !important; 
      text-align: right; 
      padding: 8px 10px !important; 
      font-size: 15px !important; 
      border: 1px solid #ddd !important; /* åŠ ä¸Šæ·ºç°é‚Šæ¡† */
      border-radius: 8px;
      background: #f9f9f9 !important;
      color: #333;
      box-sizing: border-box; /* ç¢ºä¿é‚Šæ¡†ä¸æ’å¤§ */
    }
    .split-amount:focus { 
      background: white !important; 
      border-color: var(--primary) !important; 
      outline: none;
    }
    /* é¡¯ç¤ºè‡ªå‹•è¨ˆç®—çš„ç°è‰²å­— */
    .split-amount::placeholder { color: #aaa; font-style: italic; }

    .checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
    .checkbox.checked { background: var(--primary); border-color: var(--primary); }
    .checkbox.checked::after { content: 'âœ”'; color: white; font-size: 14px; }
    
    .avatar { width: 32px; height: 32px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; font-size: 13px; flex-shrink: 0; }

    /* --- è‡ªè£½è¨ˆç®—æ©Ÿæ¨£å¼ (ä¿®æ­£ç‰ˆé¢) --- */
    .calc-overlay { position: fixed; bottom: -100%; left: 0; width: 100%; background: #f2f2f7; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 1000; padding: 15px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); box-sizing: border-box; }
    .calc-overlay.show { bottom: 0; }
    
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: 10px; height: 380px; }
    
    .calc-btn { 
      background: white; border: none; border-radius: 12px; font-size: 24px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; color: #333; font-weight: 400;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent;
      height: 100%; width: 100%;
    }
    .calc-btn:active { background: #e5e5e5; }
    
    .btn-op { background: #ff9f0a; color: white; font-weight: 500; font-size: 28px; } /* é‹ç®—ç¬¦è™Ÿæ©˜è‰² */
    .btn-op:active { background: #e68a00; }
    .btn-eq { background: var(--primary); color: white; font-weight: bold; grid-row: span 2; } /* OKéµç¶ è‰² */
    .btn-eq:active { opacity: 0.8; }
    .btn-ac { background: #d4d4d2; color: #333; font-weight: 500; } /* æ¸…é™¤éµç°è‰² */
    .btn-ac:active { background: #c0c0c0; }
    
    .input-readonly { cursor: pointer; background: white !important; color: var(--primary); caret-color: transparent; }

    /* --- [ä¿®å¾©] Footer æ¨£å¼ --- */
    .footer { 
        position: fixed; 
        bottom: 0; 
        left: 0; 
        width: 100%; 
        padding: 15px 20px; 
        background: white; 
        border-top: 1px solid var(--border); 
        display: flex; 
        box-sizing: border-box; /* é—œéµï¼šè®“ padding åŒ…å«åœ¨ width å…§ï¼Œé˜²æ­¢è·‘ç‰ˆ */
        z-index: 900; 
        padding-bottom: calc(15px + env(safe-area-inset-bottom)); /* é¿é–‹ iPhone åº•éƒ¨æ©«æ¢ */
    }
    
    .btn-main { 
        width: 100%; /* å¼·åˆ¶æ»¿ç‰ˆ */
        flex: 1; 
        background: var(--primary); 
        color: white; 
        border: none; 
        padding: 15px; 
        border-radius: 12px; 
        font-size: 16px; 
        font-weight: bold; 
        cursor: pointer; 
        box-shadow: 0 4px 12px rgba(6,199,85,0.3); 
    }
  </style>
</head>
<body>

<div class="header">
  <div class="close-btn" onclick="liff.closeWindow()">âœ•</div>
  <h1>æ–°å¢è¨˜å¸³</h1>
  <div style="width:24px"></div>
</div>

<div class="container">
  
  <div class="card">
    <label>æ—¥æœŸ & æ™‚é–“</label>
    <input type="datetime-local" id="date-input">
  </div>

  <div class="card">
    <label>å“é … <span id="predict-loading" class="loading-spin"></span></label>
    <input type="text" id="item-input" placeholder="è¼¸å…¥å…§å®¹..." onblur="predictCategory()">
    <label style="margin-top: 15px;">åˆ†é¡</label>
    <select id="category-select"><option>è¼‰å…¥ä¸­...</option></select>
  </div>

<div class="card">
    <div class="currency-toggle" id="currency-box"></div>

    <label>é‡‘é¡</label>
    <div class="input-group">
      <span class="calc-icon">ï¹©</span>
      <input type="text" id="amount-input" class="input-readonly" placeholder="0" 
             readonly onclick="openCalculator()">
    </div>

    <div id="twd-convert-row" style="margin-top: 15px; display: none;">
      <label>ğŸ’³ åˆ·å¡é€šçŸ¥å°å¹£é‡‘é¡ (é¸å¡«)</label>
      <input type="number" id="amount-twd-input" placeholder="å¯¦éš›æ‰£æ¬¾å°å¹£é‡‘é¡" style="background:#fff8e1; border-color:#ffe082;">
    </div>
  </div>

  <div id="custom-calculator" class="calc-overlay">
     <div class="calc-grid">
        <button class="calc-btn btn-ac" onclick="calcAppend('AC')">AC</button>
        <button class="calc-btn btn-ac" onclick="calcAppend('DEL')">âŒ«</button>
        <button class="calc-btn btn-op" onclick="calcAppend('/')">Ã·</button>
        <button class="calc-btn btn-op" onclick="calcAppend('*')">Ã—</button>

        <button class="calc-btn" onclick="calcAppend('7')">7</button>
        <button class="calc-btn" onclick="calcAppend('8')">8</button>
        <button class="calc-btn" onclick="calcAppend('9')">9</button>
        <button class="calc-btn btn-op" onclick="calcAppend('-')">-</button>

        <button class="calc-btn" onclick="calcAppend('4')">4</button>
        <button class="calc-btn" onclick="calcAppend('5')">5</button>
        <button class="calc-btn" onclick="calcAppend('6')">6</button>
        <button class="calc-btn btn-op" onclick="calcAppend('+')">+</button>

        <button class="calc-btn" onclick="calcAppend('1')">1</button>
        <button class="calc-btn" onclick="calcAppend('2')">2</button>
        <button class="calc-btn" onclick="calcAppend('3')">3</button>
        
        <button class="calc-btn btn-eq" style="grid-row: span 2;" onclick="calcDone()">OK</button>

        <button class="calc-btn" style="grid-column: span 2" onclick="calcAppend('0')">0</button>
        <button class="calc-btn" onclick="calcAppend('.')">.</button>
     </div>
  </div>
    <div id="twd-convert-row" style="margin-top: 15px; display: none;">
      <label>ğŸ’³ åˆ·å¡é€šçŸ¥å°å¹£é‡‘é¡ (é¸å¡«)</label>
      <input type="number" id="amount-twd-input" placeholder="å¯¦éš›æ‰£æ¬¾å°å¹£é‡‘é¡" style="background:#fff8e1; border-color:#ffe082;">
    </div>
  </div>

  <div class="card">
    <div style="display:flex; gap:10px;">
      <div style="flex:1">
        <label>å…ˆä»˜éŒ¢çš„äºº</label>
        <select id="payer-select"></select>
      </div>
      <div style="flex:1">
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="payment-select"></select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="split-header">
        <label style="margin:0">å¦‚ä½•åˆ†å¸³</label>
        <div class="split-tools">
           <div class="tool-btn" onclick="resetSplit()">é‡ç½® / å…¨é¸</div>
        </div>
    </div>
    
    <div class="split-summary">
      <span>ç¸½é¡: <span id="total-display">0</span></span>
      <span id="remainder-display" class="status-ok">åˆ†é…: è‡ªå‹•è¨ˆç®—</span>
    </div>

    <div id="split-list"></div>
    <textarea id="note-input" rows="2" placeholder="å‚™è¨»..." style="margin-top:15px;"></textarea>
  </div>

</div>

<div class="footer">
  <button class="btn-main" id="save-btn" onclick="save()">ç¢ºèªå„²å­˜</button>
</div>

<input type="hidden" id="edit-row-index">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ğŸ”´ è«‹å¡«å…¥ä½ çš„è³‡è¨Š
  const LIFF_ID = "2009010836-bedIz9Jo"; 
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwgI2bbO-8SU94pv-G7BU2MBHS2j6BjzTxFgC3YcX0bv0KLHROsi8mRaJ3FiuiefMB1/exec";

  let settings = { members: [], categories: [], payments: [], currency: "TWD" };
  let currentCurrency = "TWD";
  let splitMode = "EVEN"; // "EVEN" (å‹¾é¸) æˆ– "CUSTOM" (æ‰‹è¼¸)
  let userId = "";

  window.onload = function() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('date-input').value = now.toISOString().slice(0,16);

    liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        liff.getProfile().then(profile => {
            userId = profile.userId;
            loadData();
        });
    });
  };

  async function loadData() {
    const urlParams = new URLSearchParams(window.location.search);
    const editRow = urlParams.get('row');
    const action = editRow ? 'getEditData' : 'getSettings';

    try {
      const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action, userId, row: editRow }) }).then(r=>r.json());
      if(res.success) {
         settings = res.data;
         renderSelect('category-select', settings.categories);
         renderSelect('payer-select', settings.members);
         renderSelect('payment-select', settings.payments);
         renderCurrencyUI(settings.currency);
         renderSplitList();
         
         if(editRow && res.record) fillForm(res.record);
         else {
            if(settings.members.length > 0) document.getElementById('payer-select').value = settings.members[0];
            // é è¨­å…¨é¸
            toggleSelectAll(true);
         }
      }
    } catch(e) { alert("è¼‰å…¥éŒ¯èª¤: " + e); }
  }

  function renderSelect(id, list) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    (list||[]).forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
  }

  function renderCurrencyUI(mainCurrency) {
    const box = document.getElementById('currency-box');
    box.innerHTML = "";
    const btn1 = document.createElement('div');
    btn1.className = "c-btn active"; btn1.innerText = mainCurrency;
    btn1.onclick = () => setCurrency(mainCurrency, btn1);
    box.appendChild(btn1);
    currentCurrency = mainCurrency;

    if (mainCurrency !== "TWD") {
        const btn2 = document.createElement('div');
        btn2.className = "c-btn"; btn2.innerText = "TWD";
        btn2.onclick = () => setCurrency("TWD", btn2);
        box.appendChild(btn2);
    }
    updateTwdInputVisibility();
  }

  function setCurrency(code, btnElement) {
    currentCurrency = code;
    document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');
    updateTwdInputVisibility();
  }

  function updateTwdInputVisibility() {
    const show = (settings.currency !== "TWD" && currentCurrency !== "TWD");
    document.getElementById('twd-convert-row').style.display = show ? 'block' : 'none';
  }

  function calculateMath(el) {
    try {
      if (/^[0-9+\-*/.() ]+$/.test(el.value)) {
         el.value = eval(el.value); 
         updateSplitMath();
      }
    } catch(e) {}
  }

  async function predictCategory() {
    const item = document.getElementById('item-input').value.trim();
    if(!item) return;
    document.getElementById('predict-loading').style.display = 'inline-block';
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'predictCategory', item: item, categories: settings.categories })
      }).then(r=>r.json());
      if(res.success && res.category) document.getElementById('category-select').value = res.category;
    } catch(e) {}
    finally { document.getElementById('predict-loading').style.display = 'none'; }
  }

  function toggleSplitMode() {
    splitMode = splitMode === "EVEN" ? "CUSTOM" : "EVEN";
    renderSplitList();
  }

  function toggleMember(idx) {
    if (splitMode !== "EVEN") return;
    const chk = document.getElementById(`chk-${idx}`);
    chk.classList.toggle('checked');
    updateSplitMath();
  }

  // âœ… å…¨é¸/å…¨å–æ¶ˆåŠŸèƒ½
  function toggleSelectAll(forceSelect = null) {
    if (splitMode !== "EVEN") return; // åªæœ‰å‡åˆ†æ¨¡å¼èƒ½å…¨é¸

    const allChecks = document.querySelectorAll('.checkbox');
    // å¦‚æœå‚³å…¥ forceSelect å‰‡å¼·åˆ¶è¨­å®šï¼Œå¦å‰‡åˆ¤æ–·ç›®å‰ç‹€æ…‹
    // é‚è¼¯ï¼šåªè¦æœ‰ä¸€å€‹æ²’å‹¾ï¼Œå°±å…¨é¸ï¼›å¦‚æœéƒ½å‹¾äº†ï¼Œå°±å…¨å–æ¶ˆ
    let shouldSelectAll = true;
    if (forceSelect === null) {
       const allChecked = Array.from(allChecks).every(c => c.classList.contains('checked'));
       shouldSelectAll = !allChecked;
    } else {
       shouldSelectAll = forceSelect;
    }

    allChecks.forEach(c => {
       if(shouldSelectAll) c.classList.add('checked');
       else c.classList.remove('checked');
    });
    updateSplitMath();
  }

  function calcRemainder() {
    const total = parseFloat(document.getElementById('amount-input').value) || 0;
    let currentSum = 0;
    settings.members.forEach((m, i) => {
       currentSum += parseFloat(document.getElementById(`amt-${i}`).value) || 0;
    });
    const diff = total - currentSum;
    const el = document.getElementById('remainder-display');
    if (Math.abs(diff) < 0.1) {
       el.innerText = "å‰›å¥½åˆ†å®Œ"; el.className = "status-ok";
    } else {
       el.innerText = diff > 0 ? `å‰©é¤˜ ${diff.toFixed(1)}` : `è¶…æ”¯ ${Math.abs(diff).toFixed(1)}`;
       el.className = "status-err";
    }
  }

// ç·¨è¼¯æ¨¡å¼å›å¡« (å‡ç´šç‰ˆï¼šæ”¯æ´åè§£è‡ªè¨‚åˆ†å¸³)
  function fillForm(record) {
     document.getElementById('edit-row-index').value = window.location.search.split('row=')[1];
     document.getElementById('item-input').value = record.item;
     document.getElementById('amount-input').value = record.amount;
     document.getElementById('category-select').value = record.category;
     document.getElementById('payment-select').value = record.method;
     document.getElementById('payer-select').value = record.payer;
     document.getElementById('note-input').value = record.note;
     
     // è¨­å®šå¹£åˆ¥
     const isTwd = (record.currency === 'TWD');
     // æ‰¾åˆ°å°æ‡‰çš„å¹£åˆ¥æŒ‰éˆ• (å‡è¨­åªæœ‰å…©å€‹æŒ‰éˆ•: ä¸»å¹£åˆ¥ å’Œ TWD)
     const btns = document.querySelectorAll('.c-btn');
     if (isTwd && btns.length > 1) setCurrency('TWD', btns[1]);
     else setCurrency(record.currency, btns[0]);

     if(record.amountTWD) document.getElementById('amount-twd-input').value = record.amountTWD;

     // ğŸ§  åˆ†å¸³å›å¡«æ ¸å¿ƒé‚è¼¯
     const splitText = record.split || "";

     if (splitText === "å‡åˆ†") {
        // æƒ…å¢ƒ 1: å‡åˆ† -> å…¨é¸
        splitMode = "EVEN";
        toggleSelectAll(true); 

     } else if (splitText.startsWith("éƒ½") && splitText.endsWith("çš„")) {
        // æƒ…å¢ƒ 2: éƒ½Açš„ -> å‡åˆ†æ¨¡å¼ï¼Œåªå‹¾A
        splitMode = "EVEN";
        const name = splitText.substring(1, splitText.length - 1); // å»æ‰é ­å°¾
        toggleSelectAll(false); // å…ˆå…¨å–æ¶ˆ
        
        // å‹¾é¸è©²æˆå“¡
        settings.members.forEach((m, i) => {
           if(m === name) document.getElementById(`chk-${i}`).classList.add('checked');
        });

     } else if (splitText.includes("çš„")) {
        // æƒ…å¢ƒ 3: è‡ªè¨‚é‡‘é¡ (ä¾‹å¦‚ "Açš„10ã€Bçš„20")
        // æˆ–è€…æ˜¯ éƒ¨åˆ†å‡åˆ† (ä¾‹å¦‚ "Açš„50ã€Bçš„50")
        // é€™è£¡æˆ‘å€‘çµ±ä¸€è¦–ç‚ºã€Œè‡ªè¨‚æ¨¡å¼ (CUSTOM)ã€è™•ç†ï¼Œé€™æ¨£æœ€æº–ç¢º
        
        splitMode = "CUSTOM"; // åˆ‡æ›åˆ°æ‰‹è¼¸æ¨¡å¼
        
        // è§£æå­—ä¸²ï¼šå…ˆç”¨ã€Œã€ã€åˆ†å‰²ï¼Œå†è§£æã€Œçš„ã€
        const parts = splitText.split("ã€");
        
        // å…ˆæ¸…ç©ºæ‰€æœ‰äººçš„é‡‘é¡
        settings.members.forEach((m, i) => document.getElementById(`amt-${i}`).value = "");

        parts.forEach(part => {
           // part å¯èƒ½æ˜¯ "Açš„10"
           const [name, amount] = part.split("çš„");
           if (name && amount) {
              // æ‰¾åˆ°é€™å€‹åå­—å°æ‡‰çš„ index
              const idx = settings.members.indexOf(name);
              if (idx !== -1) {
                 document.getElementById(`amt-${idx}`).value = parseFloat(amount);
              }
           }
        });

     } else {
        // å…¶ä»–æœªçŸ¥æƒ…æ³ï¼Œç¶­æŒé è¨­æˆ–åªé¡¯ç¤ºåœ¨å‚™è¨»
        if(splitText) document.getElementById('note-input').value += ` (åŸåˆ†å¸³: ${splitText})`;
     }
     
     // æœ€å¾Œè¨˜å¾—é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼Œæ•¸å€¼æ‰æœƒé¡¯ç¤ºå‡ºä¾†
     renderSplitList();
  }
// --- è‡ªè£½è¨ˆç®—æ©Ÿé‚è¼¯ ---
  
  // é–‹å•Ÿè¨ˆç®—æ©Ÿ
  function openCalculator() {
    document.getElementById('custom-calculator').classList.add('show');
    // å¦‚æœç›®å‰é‡‘é¡æ˜¯ 0ï¼Œå…ˆæ¸…ç©ºæ–¹ä¾¿è¼¸å…¥
    const el = document.getElementById('amount-input');
    if(el.value === "0") el.value = "";
  }

  // é—œé–‰è¨ˆç®—æ©Ÿ (é»æ“ŠèƒŒæ™¯æˆ–å…¶ä»–åœ°æ–¹æ™‚å¯ä»¥å‘¼å«ï¼Œé€™è£¡å…ˆåšåœ¨ OK éµè£¡)
  function closeCalculator() {
    document.getElementById('custom-calculator').classList.remove('show');
  }

  // è™•ç†æŒ‰éµè¼¸å…¥
  function calcAppend(val) {
    const el = document.getElementById('amount-input');
    
    if (val === 'AC') {
      el.value = "";
    } else if (val === 'DEL') {
      el.value = el.value.slice(0, -1);
    } else {
      // é¿å…é‡è¤‡è¼¸å…¥é‹ç®—ç¬¦è™Ÿ (ç°¡æ˜“é˜²å‘†)
      const lastChar = el.value.slice(-1);
      const isOp = ['+','-','*','/'].includes(val);
      if (isOp && ['+','-','*','/'].includes(lastChar)) {
         el.value = el.value.slice(0, -1) + val; // æ›¿æ›æœ€å¾Œä¸€å€‹ç¬¦è™Ÿ
      } else {
         el.value += val;
      }
    }
  }

// æŒ‰ä¸‹ OKï¼šè¨ˆç®—çµæœä¸¦æ›´æ–°åˆ†å¸³
  function calcDone() {
    const el = document.getElementById('amount-input');
    try {
      if (el.value) {
        // ç§»é™¤å¯èƒ½åœ¨çµå°¾çš„é‹ç®—ç¬¦è™Ÿ (ä¾‹å¦‚ "100+" -> "100")
        let safeValue = el.value.replace(/[+\-*/]*$/, '');
        
        // ä½¿ç”¨ Function åŸ·è¡Œæ•¸å­¸é‹ç®—
        const result = new Function('return ' + safeValue)(); 
        
        // è™•ç†ç„¡é™å¤§æˆ–éæ•¸å­—çš„æƒ…æ³
        if (!isFinite(result) || isNaN(result)) {
            el.value = "0";
        } else {
            // å–å…©ä½å°æ•¸ä¸¦è½‰å›æ•¸å­—ï¼Œé¿å…ç²¾åº¦å•é¡Œ
            el.value = Math.round(result * 100) / 100;
        }
        
        // è§¸ç™¼åŸæœ¬çš„åˆ†å¸³æ›´æ–°é‚è¼¯
        updateSplitMath(); 
      }
    } catch (e) {
      alert("ç®—å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
      el.value = ""; // æ¸…ç©ºéŒ¯èª¤è¼¸å…¥
    }
    
    // âš ï¸ é—œéµï¼šé€™è¡Œä¸€å®šè¦åœ¨æœ€å¾Œé¢ï¼Œè² è²¬é—œé–‰è¨ˆç®—æ©Ÿé¢æ¿
    closeCalculator();
  }

  // --- åˆ†å¸³æ ¸å¿ƒé‚è¼¯ (Hybrid Mode) ---

// 1. æ¸²æŸ“åˆ—è¡¨ (ä¿®å¾©ç‰ˆ)
  function renderSplitList() {
    const list = document.getElementById('split-list');
    const oldHtml = list.innerHTML;
    list.innerHTML = "";
    
    settings.members.forEach((member, idx) => {
      let isChecked = true;
      let existingVal = "";

      // å˜—è©¦ä¿ç•™è¼¸å…¥ç‹€æ…‹
      if (oldHtml) {
         const oldChk = document.getElementById(`chk-${idx}`);
         const oldInp = document.getElementById(`amt-${idx}`);
         if (oldChk) isChecked = oldChk.classList.contains('checked');
         if (oldInp) existingVal = oldInp.value;
      }

      const row = document.createElement('div');
      row.className = "split-row";
      const initial = member.substring(0,1);
      const inputClass = existingVal ? "split-amount has-value" : "split-amount";

      // ğŸ”¥ [ä¿®æ­£é»] ç§»é™¤é‡è¤‡çš„ user-name
      row.innerHTML = `
        <div class="user-info" onclick="toggleSplitMember(${idx})">
           <div class="checkbox ${isChecked?'checked':''}" id="chk-${idx}"></div>
           <div class="avatar">${initial}</div>
           <div class="user-name">${member}</div>
        </div>
        <div class="split-input-group">
           <input type="number" class="${inputClass}" id="amt-${idx}" 
                  placeholder="0" value="${existingVal}" 
                  oninput="onSplitInput(${idx})" onclick="this.select()">
        </div>
      `;
      list.appendChild(row);
    });
    updateSplitMath();
  }

  // 2. é»æ“Šåå­—/å‹¾é¸æ¡†
  function toggleSplitMember(idx) {
    const chk = document.getElementById(`chk-${idx}`);
    chk.classList.toggle('checked');
    
    // å¦‚æœå–æ¶ˆå‹¾é¸ï¼Œæ¸…ç©ºè©²ä½¿ç”¨è€…çš„è¼¸å…¥å€¼
    if (!chk.classList.contains('checked')) {
        const inp = document.getElementById(`amt-${idx}`);
        inp.value = "";
        inp.classList.remove('has-value');
    }
    updateSplitMath();
  }

  // 3. è¼¸å…¥é‡‘é¡æ™‚
  function onSplitInput(idx) {
    const inp = document.getElementById(`amt-${idx}`);
    const chk = document.getElementById(`chk-${idx}`);
    
    // å¦‚æœè¼¸å…¥äº†æ•¸å­—ï¼Œè‡ªå‹•å‹¾é¸è©²ä½¿ç”¨è€…
    if (inp.value !== "") {
        chk.classList.add('checked');
        inp.classList.add('has-value');
    } else {
        inp.classList.remove('has-value');
    }
    updateSplitMath();
  }

  // 4. é‡ç½® / å…¨é¸æŒ‰éˆ•
  function resetSplit() {
    settings.members.forEach((m, i) => {
       document.getElementById(`chk-${i}`).classList.add('checked');
       const inp = document.getElementById(`amt-${i}`);
       inp.value = "";
       inp.classList.remove('has-value');
    });
    updateSplitMath();
  }

  // 5. âœ… æ ¸å¿ƒé‹ç®—ï¼šå³æ™‚è¨ˆç®—æ¯å€‹äººè©²ä»˜å¤šå°‘
  function updateSplitMath() {
    const total = parseFloat(document.getElementById('amount-input').value) || 0;
    document.getElementById('total-display').innerText = total;

    let manualSum = 0;
    let manualCount = 0;
    let autoCount = 0; // æœ‰å‹¾é¸ä½†æ²’è¼¸å…¥é‡‘é¡çš„äºº (åƒèˆ‡å‡åˆ†çš„äºº)

    // ç¬¬ä¸€è¼ªï¼šçµ±è¨ˆæ‰‹å‹•è¼¸å…¥çš„é‡‘é¡ & é‚„æœ‰èª°è¦å‡åˆ†
    settings.members.forEach((m, i) => {
       const chk = document.getElementById(`chk-${i}`);
       const inp = document.getElementById(`amt-${i}`);
       const isChecked = chk.classList.contains('checked');
       const valStr = inp.value;

       if (isChecked) {
           if (valStr !== "") {
               // æœ‰æŒ‡å®šé‡‘é¡
               manualSum += parseFloat(valStr);
               manualCount++;
           } else {
               // æ²’æŒ‡å®šé‡‘é¡ï¼ŒåŠ å…¥å‡åˆ†æ± 
               autoCount++;
           }
       } else {
           // æ²’å‹¾é¸çš„äººï¼Œå¼·åˆ¶é‡‘é¡é¡¯ç¤ºç‚ºç©ºæˆ– 0
           // inp.placeholder = "0"; 
       }
    });

    // è¨ˆç®—å‰©é¤˜é‡‘é¡
    const remaining = total - manualSum;
    const perPerson = autoCount > 0 ? Math.round((remaining / autoCount) * 100) / 100 : 0;

    // ç¬¬äºŒè¼ªï¼šæ›´æ–° UI é¡¯ç¤º (Placeholder)
    settings.members.forEach((m, i) => {
       const chk = document.getElementById(`chk-${i}`);
       const inp = document.getElementById(`amt-${i}`);
       const isChecked = chk.classList.contains('checked');
       const valStr = inp.value;

       if (!isChecked) {
           inp.placeholder = "ä¸åƒèˆ‡";
       } else if (valStr === "") {
           // åƒèˆ‡å‡åˆ†çš„äººï¼Œé¡¯ç¤ºè¨ˆç®—å¾Œçš„é‡‘é¡
           inp.placeholder = perPerson;
       } else {
           // æœ‰æ‰‹å‹•è¼¸å…¥çš„äººï¼Œplaceholder ä¸é‡è¦
       }
    });

    // æ›´æ–°ç‹€æ…‹æ–‡å­—
    const infoEl = document.getElementById('remainder-display');
    if (autoCount === 0) {
        // å¦‚æœæ²’æœ‰äººå‡åˆ† (å…¨éƒ¨éƒ½æ˜¯æ‰‹å‹•è¼¸å…¥ï¼Œæˆ–è€…éƒ½æ²’å‹¾)
        if (Math.abs(remaining) < 0.1) {
            infoEl.innerText = "å®Œç¾åˆ†é…"; infoEl.className = "status-ok";
        } else {
            infoEl.innerText = remaining > 0 ? `é‚„æœ‰ ${remaining} æœªåˆ†` : `è¶…æ”¯ ${Math.abs(remaining)}`;
            infoEl.className = "status-err";
        }
    } else {
        // é‚„æœ‰å‰©é¤˜é‡‘é¡çµ¦ autoCount çš„äººåˆ†
        if (remaining < 0) {
            infoEl.innerText = `è¶…æ”¯ ${Math.abs(remaining)} (è«‹ä¿®æ­£)`;
            infoEl.className = "status-err";
        } else {
            infoEl.innerText = `å‰©é¤˜ ${remaining} çµ¦ ${autoCount} äººå‡åˆ†`;
            infoEl.className = "status-ok";
        }
    }
  }

  // 6. âœ… ç”¢ç”Ÿåˆ†å¸³å­—ä¸² (ç¬¦åˆä½ çš„éœ€æ±‚)
  function getSplitText() {
    // æª¢æŸ¥æ˜¯å¦æœ‰ã€Œä»»ä½•ã€æ‰‹å‹•è¼¸å…¥çš„é‡‘é¡
    let hasManualInput = false;
    let checkedCount = 0;
    const totalMembers = settings.members.length;

    settings.members.forEach((m, i) => {
        if (document.getElementById(`amt-${i}`).value !== "") hasManualInput = true;
        if (document.getElementById(`chk-${i}`).classList.contains('checked')) checkedCount++;
    });

    // æƒ…å¢ƒ 1: å‡åˆ† (å…¨é¸ + ç„¡æ‰‹å‹•è¼¸å…¥)
    if (checkedCount === totalMembers && !hasManualInput) {
        return "å‡åˆ†";
    }

    // æƒ…å¢ƒ 2: éƒ½èª°çš„ (åªå‹¾ 1 äºº + ç„¡æ‰‹å‹•è¼¸å…¥)
    if (checkedCount === 1 && !hasManualInput) {
        let name = "";
        settings.members.forEach((m, i) => {
            if (document.getElementById(`chk-${i}`).classList.contains('checked')) name = m;
        });
        return "éƒ½" + name + "çš„";
    }

    // æƒ…å¢ƒ 4: æ²’äººå‹¾ (Null)
    if (checkedCount === 0) {
        return null;
    }

    // æƒ…å¢ƒ 3: æ··åˆæ¨¡å¼ (æœ‰æ‰‹å‹•è¼¸å…¥ï¼Œæˆ–éƒ¨åˆ†å‹¾é¸) -> ç”¢ç”Ÿ "Açš„10ã€Bçš„0"
    // é‚è¼¯ï¼šåªè¦æœ‰ã€Œæ‰‹å‹•è¼¸å…¥ã€çš„äººï¼Œæˆ‘å€‘å°±æ˜ç¢ºåˆ—å‡ºã€‚
    // å¦‚æœæ˜¯ã€Œæ²’å‹¾é¸ã€çš„äººï¼Œæ˜¯å¦è¦é€ "Xçš„0"ï¼Ÿæ ¹æ“šä½ çš„éœ€æ±‚ 3ï¼ŒSheet æœƒè‡ªå‹•åˆ†å‰©ä¸‹çš„ã€‚
    // æ‰€ä»¥æˆ‘å€‘åªè¦é€å‡ºã€Œè¢«æ˜ç¢ºæŒ‡å®šé‡‘é¡ã€çš„äººå°±å¥½ï¼Ÿ
    // ä¿®æ­£ï¼šç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œå¦‚æœæœ‰äººè¢«ã€Œå–æ¶ˆå‹¾é¸ã€ï¼Œæˆ‘å€‘æ‡‰è©²è¦–ç‚ºã€ŒæŒ‡å®šç‚º 0ã€ã€‚
    
    let parts = [];
    settings.members.forEach((m, i) => {
        const chk = document.getElementById(`chk-${i}`);
        const inp = document.getElementById(`amt-${i}`);
        const valStr = inp.value;

        if (chk.classList.contains('checked')) {
            // æœ‰å‹¾é¸
            if (valStr !== "") {
                // æœ‰æŒ‡å®šé‡‘é¡ -> "Açš„10"
                parts.push(`${m}çš„${valStr}`);
            } else {
                // æœ‰å‹¾é¸ä½†æ²’è¼¸å…¥ -> é€™æ˜¯ã€Œå‰©é¤˜å‡åˆ†ã€çš„äººï¼Œä¸ç”¨å¯«åœ¨å­—ä¸²è£¡ï¼Œè®“ Sheet è‡ªå·±ç®—
            }
        } else {
            // æ²’å‹¾é¸ -> è¦–ç‚º "Açš„0" (å¼·åˆ¶ä¸åƒèˆ‡)
            // é€™æ¨£ Sheet åœ¨ç®—å‰©é¤˜å‡åˆ†æ™‚ï¼Œå°±ä¸æœƒåˆ†çµ¦ä»–
            parts.push(`${m}çš„0`);
        }
    });

    return parts.join("ã€");
  }

  // 7. ç·¨è¼¯å›å¡« (Fill Form) éœ€è¦é…åˆä¿®æ”¹
  function fillForm(record) {
     // ... (å‰é¢åŸºæœ¬çš„ item, amount, category ç­‰å›å¡«é‚è¼¯ä¸è®Š) ...
     document.getElementById('edit-row-index').value = window.location.search.split('row=')[1];
     document.getElementById('item-input').value = record.item;
     document.getElementById('amount-input').value = record.amount;
     document.getElementById('category-select').value = record.category;
     document.getElementById('payment-select').value = record.method;
     document.getElementById('payer-select').value = record.payer;
     document.getElementById('note-input').value = record.note;
     
     const isTwd = (record.currency === 'TWD');
     const btns = document.querySelectorAll('.c-btn');
     if (isTwd && btns.length > 1) setCurrency('TWD', btns[1]);
     else setCurrency(record.currency, btns[0]);

     if(record.amountTWD) document.getElementById('amount-twd-input').value = record.amountTWD;

     // --- åˆ†å¸³å›å¡«é‚è¼¯ ---
     const splitText = record.split || "å‡åˆ†"; // é è¨­å‡åˆ†
     
     // å…ˆé‡ç½®æ‰€æœ‰ç‹€æ…‹ (å…¨é¸ã€ç„¡é‡‘é¡)
     resetSplit();

     if (splitText === "å‡åˆ†") {
        // é è¨­å°±æ˜¯å…¨é¸ï¼Œä¸ç”¨å‹•
     } else if (splitText.startsWith("éƒ½") && splitText.endsWith("çš„")) {
        // "éƒ½Açš„"
        const name = splitText.substring(1, splitText.length - 1);
        settings.members.forEach((m, i) => {
            const chk = document.getElementById(`chk-${i}`);
            // åªå‹¾é¸è©²äººï¼Œå…¶ä»–äººå–æ¶ˆ
            if (m === name) chk.classList.add('checked');
            else chk.classList.remove('checked');
        });
     } else {
        // "Açš„10ã€Bçš„0" (æ··åˆæ¨¡å¼)
        // è§£æå­—ä¸²
        const parts = splitText.split("ã€");
        
        // æ­¤æ™‚ç­–ç•¥ï¼š
        // 1. å…ˆæŠŠæ‰€æœ‰äººéƒ½è¨­ç‚ºã€Œæœ‰å‹¾é¸ã€ç„¡é‡‘é¡ã€(å‡åˆ†æ± ) -> é€™æ˜¯ resetSplit åšçš„äº‹
        // 2. è®€å–å­—ä¸²ï¼Œå¦‚æœå­—ä¸²æœ‰ "Açš„10"ï¼Œå¡«å…¥ 10ã€‚
        // 3. å¦‚æœå­—ä¸²æœ‰ "Bçš„0"ï¼Œå¡«å…¥ 0 (ä¸”å–æ¶ˆå‹¾é¸ï¼Ÿæˆ–è€…å‹¾é¸ä½†é‡‘é¡ç‚º0ï¼Ÿæ ¹æ“šä½ çš„é‚è¼¯æ˜¯å‹¾é¸å¡«0)ã€‚
        //    *ä¿®æ­£ï¼šä½ çš„éœ€æ±‚æ˜¯ Açš„10ã€Bçš„0 -> Aå¡«10ï¼ŒBå¡«0ã€‚
        
        parts.forEach(part => {
           const [name, amount] = part.split("çš„");
           if (name && amount !== undefined) {
              const idx = settings.members.indexOf(name);
              if (idx !== -1) {
                  const val = parseFloat(amount);
                  const inp = document.getElementById(`amt-${idx}`);
                  const chk = document.getElementById(`chk-${idx}`);
                  
                  inp.value = val;
                  inp.classList.add('has-value');
                  
                  // å¦‚æœæ˜¯ 0ï¼Œä½ å¯ä»¥æ±ºå®šè¦ä¸è¦å–æ¶ˆå‹¾é¸ï¼Œ
                  // ä½†æ ¹æ“šä½ çš„é‚è¼¯ï¼Œå¡« 0 ä¹Ÿæ˜¯ä¸€ç¨®æ˜ç¢ºçš„æŒ‡å®šï¼Œæ‰€ä»¥ä¿æŒå‹¾é¸æ¯”è¼ƒå¥½ç†è§£
                  chk.classList.add('checked'); 
              }
           }
        });
        
        // é‚„æœ‰ä¸€å€‹é‚Šç·£æƒ…æ³ï¼šå¦‚æœæœ‰äººæ²’åœ¨å­—ä¸²è£¡ï¼Œä¹Ÿæ²’è¢«å‹¾é¸æ€éº¼è¾¦ï¼Ÿ
        // ä½ çš„ Sheet é‚è¼¯æ˜¯ã€Œå‰©ä¸‹çš„å‡åˆ†ã€ã€‚
        // æ‰€ä»¥æ²’å‡ºç¾åœ¨å­—ä¸²è£¡çš„äººï¼Œæ‡‰è©²ä¿æŒã€Œå‹¾é¸ + ç©ºç™½é‡‘é¡ã€ï¼Œè®“ä»–å€‘å»åˆ†å‰©ä¸‹çš„ã€‚
     }
     
     updateSplitMath();
  }

// âœ… æ™ºæ…§å‹å„²å­˜å‡½å¼ (å¿«å–æ¥åŠ›ç‰ˆ)
  function save() {
    const splitText = getSplitText();
    const payload = {
      date: document.getElementById('date-input').value,
      item: document.getElementById('item-input').value,
      category: document.getElementById('category-select').value,
      amount: document.getElementById('amount-input').value,
      currency: currentCurrency,
      amountTWD: document.getElementById('amount-twd-input').value || null,
      payer: document.getElementById('payer-select').value,
      method: document.getElementById('payment-select').value, 
      split: splitText,
      note: document.getElementById('note-input').value,
      row: document.getElementById('edit-row-index').value
    };

    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";

    // åˆ¤æ–·ç’°å¢ƒ
    if (liff.isInClient()) {
        // ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šå…ˆç”¨ Fetch å‚³è³‡æ–™çµ¦ GAS (useCache: true)
        fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveTransaction', userId: userId, data: payload, useCache: true })
        })
        .then(r => r.json())
        .then(res => {
           if(res.success) {
               // è³‡æ–™å·²å‚³çµ¦å¾Œç«¯å­˜å¿«å–ï¼Œç¾åœ¨ç™¼é€è§¸ç™¼æŒ‡ä»¤
               liff.sendMessages([{ type: 'text', text: "âœ… è¨˜å¸³å®Œæˆ" }])
                   .then(() => liff.closeWindow())
                   .catch(err => {
                       // è¬ä¸€ä½¿ç”¨è€…æ²’æˆæ¬Šç™¼è¨Šæ¯ï¼Œè‡³å°‘è³‡æ–™å·²ç¶“å­˜äº†ï¼Œç›´æ¥é—œé–‰
                       console.error(err);
                       liff.closeWindow();
                   });
           } else {
               alert("å„²å­˜å¤±æ•—: " + res.error);
               btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜";
           }
        })
        .catch(e => {
            alert("ç¶²è·¯éŒ¯èª¤: " + e);
            btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜";
        });

    } else {
        // ğŸ’» é›»è…¦ç‰ˆï¼šèµ°åŸæœ¬çš„ Push è·¯ç·š
        sendByFetch(payload, btn);
    }
  }

  // âœ… 2. è¼”åŠ©ï¼šFetch å‚³é€ (çµ¦é›»è…¦ç‰ˆæˆ–å¤±æ•—æ™‚ç”¨)
  function sendByFetch(payload, btn) {
    fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveTransaction', userId: userId, data: payload })
    })
    .then(r=>r.json())
    .then(res => {
       if(res.success) {
           // é›»è…¦ç‰ˆç„¡æ³• closeWindowï¼Œæ”¹ç‚ºè·³å‡ºæç¤ºä¸¦é‡æ•´
           alert("âœ… å„²å­˜æˆåŠŸï¼\n(è«‹æ‰‹å‹•é—œé–‰æ­¤è¦–çª—)");
           window.location.reload(); 
       }
       else { 
           alert("å¤±æ•—: " + res.error); 
           btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; 
       }
    })
    .catch(e => { 
        alert("éŒ¯èª¤: " + e); 
        btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜"; 
    });
  }
</script>
</body>
</html>
