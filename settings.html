<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å¸³æœ¬è¨­å®š</title>
  <style>
    :root { --primary: #06c755; --bg: #f2f5f8; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); padding: 15px; margin: 0; color: #333; }
    
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; }
    h2 { color: var(--primary); text-align: center; margin: 0 0 5px 0; }
    h3 { font-size: 1rem; border-left: 4px solid var(--primary); padding-left: 8px; margin-top: 20px; }
    
    /* è¼¸å…¥æ¡†æ¨£å¼ */
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 5px; -webkit-appearance: none; font-size: 16px; background: #fff; }
    input:focus, select:focus { border-color: var(--primary); outline: none; }

    .tag-box { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .tag { background: #eefcf3; padding: 6px 12px; border-radius: 20px; border: 1px solid #ccebd4; display: flex; align-items: center; font-size: 14px; }
    .tag .rm { color: #ff5e5e; margin-left: 8px; cursor: pointer; font-weight: bold; }
    
    .add-row { display: flex; gap: 5px; }
    .btn-add { background: #eee; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-size: 20px; color: #666;}
    .btn-save { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: none; box-shadow: 0 4px 10px rgba(6,199,85,0.3); }
    .btn-save:disabled { background: #ccc; box-shadow: none; }
    
    .hint { font-size: 12px; color: #999; margin-bottom: 5px; display: flex; justify-content: space-between; }
    .rate-loading { color: var(--primary); font-weight: bold; font-size: 12px; display: none; }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p id="loading-text" style="margin-top:15px; color:#666;">å•Ÿå‹•ä¸­...</p>
</div>

<div class="card" id="main-ui">
  <h2>âš™ï¸ å¸³æœ¬è¨­å®š</h2>
  <div id="ledger-title" style="text-align:center; color:#888; margin-bottom:20px;">...</div>

  <h3>æˆå“¡ <span style="font-size:12px; font-weight:normal; color:#aaa">(æœ€å¤š13äºº)</span></h3>
  <div id="members-list" class="tag-box"></div>
  <div class="add-row">
    <input type="text" id="new-member" placeholder="è¼¸å…¥åå­—">
    <button type="button" class="btn-add" onclick="add('members-list', 'new-member', 13)">ï¼‹</button>
  </div>

  <h3>å¹£åˆ¥ & åŒ¯ç‡</h3>
  <div style="display:flex; gap:10px; align-items: flex-start;">
     <div style="flex:1">
       <select id="currency-select" onchange="onCurrencyChange()">
         <option value="TWD">TWD (å°å¹£)</option>
         <option value="JPY">JPY (æ—¥å¹£)</option>
         <option value="USD">USD (ç¾é‡‘)</option>
         <option value="EUR">EUR (æ­å…ƒ)</option>
         <option value="KRW">KRW (éŸ“å…ƒ)</option>
         <option value="THB">THB (æ³°éŠ–)</option>
         <option value="CNY">CNY (äººæ°‘å¹£)</option>
         <option value="HKD">HKD (æ¸¯å¹£)</option>
         <option value="OTHER">è‡ªè¡Œè¼¸å…¥...</option>
       </select>
       <input type="text" id="currency-other" placeholder="è¼¸å…¥ä»£ç¢¼ (å¦‚ GBP)" style="display:none; margin-top:5px;" onchange="updateRateFromOther()">
     </div>

     <div style="flex:1">
       <input type="number" id="rate" step="0.0001" placeholder="åŒ¯ç‡">
     </div>
  </div>
  
  <div class="hint">
    <span>* é¸æ“‡å¹£åˆ¥è‡ªå‹•æŠ“åŒ¯ç‡</span>
    <span id="fetching-msg" class="rate-loading">ğŸ”„ æ›´æ–°åŒ¯ç‡ä¸­...</span>
  </div>

  <h3>ä»˜æ¬¾æ–¹å¼ <span style="font-size:12px; font-weight:normal; color:#aaa">(æœ€å¤š6ç¨®)</span></h3>
  <div id="payments-list" class="tag-box"></div>
  <div class="add-row">
    <input type="text" id="new-payment" placeholder="å¦‚ å¯Œé‚¦Jå¡">
    <button type="button" class="btn-add" onclick="add('payments-list', 'new-payment', 6)">ï¼‹</button>
  </div>

  <h3>é …ç›®åˆ†é¡ <span style="font-size:12px; font-weight:normal; color:#aaa">(æœ€å¤š8ç¨®)</span></h3>
  <div id="categories-list" class="tag-box"></div>
  <div class="add-row">
    <input type="text" id="new-category" placeholder="å¦‚ äº¤é€š, ä½å®¿">
    <button type="button" class="btn-add" onclick="add('categories-list', 'new-category', 8)">ï¼‹</button>
  </div>
</div>

<button class="btn-save" id="save-btn" onclick="save()">ğŸ’¾ å„²å­˜è¨­å®š</button>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ğŸ”´ é€™è£¡è«‹å¡«å…¥æ­£ç¢ºè³‡è¨Š
  const MY_LIFF_ID = "2009010836-1OaNzGM2"; 
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwgI2bbO-8SU94pv-G7BU2MBHS2j6BjzTxFgC3YcX0bv0KLHROsi8mRaJ3FiuiefMB1/exec"; 

  var store = { m: [], p: [], c: [] };
  var currentUserId = "";

  window.onload = function() {
    liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) { liff.login(); return; }
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          document.getElementById('loading-text').innerText = "è®€å–è¨­å®šä¸­...";
          fetchData(currentUserId);
        });
    }).catch(err => { alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err); });
  };

  function fetchData(uid) {
    fetch(GAS_API_URL, {
      method: 'POST',
      redirect: "follow",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: 'getSettings', userId: uid })
    })
    .then(response => response.text())
    .then(text => {
      try {
        const res = JSON.parse(text);
        if (res.success) {
          var d = res.data;
          store.m = d.members || [];
          store.p = d.payments || [];
          store.c = d.categories || [];
          
          document.getElementById('ledger-title').innerText = d.ledgerName;
          
          // ğŸ”¥ è¨­å®šå¹£åˆ¥é¸å–®é‚è¼¯
          setCurrencyUI(d.currency);
          
          document.getElementById('rate').value = d.rate;
          
          render('members-list', store.m);
          render('payments-list', store.p);
          render('categories-list', store.c);
          
          document.getElementById('loading').style.display = 'none';
          document.getElementById('main-ui').style.display = 'block';
          document.getElementById('save-btn').style.display = 'block';
        } else {
          alert("è®€å–å¤±æ•—: " + res.error);
        }
      } catch (e) {
        console.error("RAW RESPONSE:", text);
        alert("GAS é€£ç·šéŒ¯èª¤:\n" + text.replace(/<[^>]*>?/gm, '').substring(0, 200));
      }
    })
    .catch(err => alert("ç¶²è·¯é€£ç·šéŒ¯èª¤: " + err));
  }

  // ğŸ”¥ æ–°å¢åŠŸèƒ½ï¼šè™•ç†å¹£åˆ¥é¸å–®è®ŠåŒ–
  function onCurrencyChange() {
    var select = document.getElementById('currency-select');
    var otherInput = document.getElementById('currency-other');
    var val = select.value;

    if (val === "OTHER") {
      otherInput.style.display = "block"; // é¡¯ç¤ºè‡ªè¨‚æ ¼å­
      otherInput.value = "";
      otherInput.focus();
    } else {
      otherInput.style.display = "none"; // éš±è—è‡ªè¨‚æ ¼å­
      updateRate(val); // è‡ªå‹•æŠ“åŒ¯ç‡
    }
  }

  // ç•¶ä½¿ç”¨è€…åœ¨ã€Œå…¶ä»–ã€æ ¼å­è¼¸å…¥å®Œç•¢å¾ŒæŠ“åŒ¯ç‡
  function updateRateFromOther() {
    var val = document.getElementById('currency-other').value.toUpperCase();
    if (val.length === 3) {
       updateRate(val);
    }
  }

  // ğŸ”¥ æ–°å¢åŠŸèƒ½ï¼šå‘¼å«å¤–éƒ¨ API æŠ“åŒ¯ç‡
  function updateRate(currencyCode) {
    if (!currencyCode || currencyCode === "TWD") {
       document.getElementById('rate').value = 1;
       return;
    }

    var loadingMsg = document.getElementById('fetching-msg');
    loadingMsg.style.display = "inline"; // é¡¯ç¤ºè½‰åœˆæ–‡å­—

    // ä½¿ç”¨å…è²»çš„ ExchangeRate-API
    fetch('https://api.exchangerate-api.com/v4/latest/' + currencyCode)
      .then(res => res.json())
      .then(data => {
         // æ‰¾å‡ºå° TWD çš„åŒ¯ç‡
         var rateToTwd = data.rates.TWD;
         if (rateToTwd) {
            document.getElementById('rate').value = rateToTwd;
         } else {
            alert("æ‰¾ä¸åˆ°æ­¤å¹£åˆ¥åŒ¯ç‡ï¼Œè«‹æ‰‹å‹•è¼¸å…¥");
         }
      })
      .catch(err => {
         console.log("åŒ¯ç‡æŠ“å–å¤±æ•—", err);
         // å¤±æ•—ä¸è·³ Alert å¹²æ“¾ï¼Œè®“ä½¿ç”¨è€…è‡ªå·±å¡«
      })
      .finally(() => {
         loadingMsg.style.display = "none"; // éš±è—è½‰åœˆæ–‡å­—
      });
  }

  // åˆå§‹åŒ–æ™‚ï¼Œæ ¹æ“šå¾Œç«¯å‚³ä¾†çš„å¹£åˆ¥è¨­å®š UI
  function setCurrencyUI(savedCurrency) {
     var select = document.getElementById('currency-select');
     var otherInput = document.getElementById('currency-other');
     
     // æª¢æŸ¥é€™å€‹å¹£åˆ¥æœ‰æ²’æœ‰åœ¨æˆ‘å€‘çš„é¸å–®è£¡
     var exists = false;
     for (var i = 0; i < select.options.length; i++) {
        if (select.options[i].value === savedCurrency) {
           exists = true;
           break;
        }
     }

     if (exists) {
        select.value = savedCurrency;
        otherInput.style.display = "none";
     } else {
        select.value = "OTHER";
        otherInput.style.display = "block";
        otherInput.value = savedCurrency;
     }
  }

  function save() {
    var btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";
    
    // ğŸ”¥ åˆ¤æ–·æœ€çµ‚å¹£åˆ¥æ˜¯é¸å–®çš„é‚„æ˜¯è‡ªè¨‚çš„
    var selectVal = document.getElementById('currency-select').value;
    var finalCurrency = selectVal;
    
    if (selectVal === "OTHER") {
       finalCurrency = document.getElementById('currency-other').value.trim().toUpperCase();
       if (!finalCurrency) finalCurrency = "TWD"; // é˜²å‘†
    }

    var payload = {
       members: store.m, payments: store.p, categories: store.c,
       currency: finalCurrency, rate: document.getElementById('rate').value
    };

    fetch(GAS_API_URL, {
      method: 'POST',
      redirect: "follow",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: 'saveSettings', userId: currentUserId, data: payload })
    })
    .then(response => response.text())
    .then(text => {
       try {
         const res = JSON.parse(text);
         if(res.success) {
            alert("âœ… è¨­å®šå·²å„²å­˜ï¼");
            liff.closeWindow();
         } else {
            alert("âŒ å¤±æ•—: " + res.error);
            btn.disabled = false; btn.innerText = "ğŸ’¾ å„²å­˜è¨­å®š";
         }
       } catch (e) {
         alert("âš ï¸ å„²å­˜éŒ¯èª¤:\n" + text.replace(/<[^>]*>?/gm, '').substring(0, 200));
         btn.disabled = false; btn.innerText = "ğŸ’¾ å„²å­˜è¨­å®š";
       }
    })
    .catch(err => {
       alert("é€£ç·šéŒ¯èª¤: " + err);
       btn.disabled = false; btn.innerText = "ğŸ’¾ å„²å­˜è¨­å®š";
    });
  }

  function render(id, arr) {
    var el = document.getElementById(id);
    el.innerHTML = "";
    arr.forEach(function(item, i) {
      el.innerHTML += '<div class="tag">' + item + '<span class="rm" onclick="rm(\''+id+'\','+i+')">Ã—</span></div>';
    });
  }
  function add(id, inputId, limit) {
    var input = document.getElementById(inputId);
    var val = input.value.trim();
    var key = (id==='members-list')?'m':(id==='payments-list')?'p':'c';
    if(val && store[key].length < limit) {
       store[key].push(val); render(id, store[key]); input.value = "";
    }
  }
  function rm(id, idx) {
    var key = (id==='members-list')?'m':(id==='payments-list')?'p':'c';
    store[key].splice(idx, 1); render(id, store[key]);
  }
</script>
</body>
</html>


