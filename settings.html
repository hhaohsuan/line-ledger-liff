<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å¸³æœ¬è¨­å®š</title>
  <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --primary: #06c755; --primary-light: #e8f9ee;
      --bg: #f7f9fc; --card-bg: #ffffff;
      --text: #333333; --text-sub: #888888;
      --border: #e1e5eb; --input-bg: #f9f9f9; --red: #ff4b4b;
    }

    /* ä¸»é¡Œè‰²ç³» */
    body[data-color="blue"] { --primary: #007bff; --primary-light: #e6f2ff; }
    body[data-color="purple"] { --primary: #8e44ad; --primary-light: #f4ecf7; }
    body[data-color="orange"] { --primary: #ff9800; --primary-light: #fff3e0; }
    body[data-color="pink"] { --primary: #ff6b81; --primary-light: #ffeef0; }

    /* ğŸŒ™ æš—é»‘æ¨¡å¼ */
    body.dark-mode {
      --bg: #121212; --card-bg: #1e1e1e;
      --text: #e0e0e0; --text-sub: #aaaaaa;
      --border: #333333; --input-bg: #2c2c2c;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); transition: background 0.3s, color 0.3s; }

    /* Header */
    .header { background: var(--card-bg); padding: 15px 20px; box-shadow: 0 1px 0 var(--border); position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
    .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    
    .settings-area { display: flex; gap: 10px; align-items: center; }
    .theme-select { padding: 5px; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 14px; outline: none; }
    .icon-btn { font-size: 20px; cursor: pointer; padding: 5px; border: none; background: transparent; color: var(--text-sub); line-height: 1; }

    .container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: background 0.3s; }
    
    label { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; display: block; font-weight: 500; }
    
    input, select { 
        width: 100%; padding: 12px; font-size: 16px; 
        border: 1px solid var(--border); border-radius: 12px; 
        background: var(--input-bg); color: var(--text);
        outline: none; transition: 0.2s; appearance: none;
    }
    input:focus { border-color: var(--primary); background: var(--card-bg); }

    /* æ¨™ç±¤æ¨£å¼ (Tags) */
    .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .tag { 
        background: var(--primary-light); color: var(--primary); 
        padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 500;
        display: flex; align-items: center; gap: 6px;
    }
    .tag .rm { cursor: pointer; font-weight: bold; opacity: 0.6; padding: 0 4px; }
    .tag .rm:hover { opacity: 1; color: var(--red); }

    .input-row { display: flex; gap: 10px; margin-bottom: 5px; }
    .btn-add { 
        padding: 0 20px; background: var(--input-bg); color: var(--primary); 
        border: 1px solid var(--border); border-radius: 12px; font-weight: bold; cursor: pointer;
    }
    .btn-add:active { background: var(--primary-light); }

    /* Footer */
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: var(--card-bg); border-top: 1px solid var(--border); display: flex; z-index: 900; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
    .btn-main { width: 100%; flex: 1; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: 0.2s; }
    .btn-main:active { transform: scale(0.98); }
    .btn-main:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

    /* Loading */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- ğŸ”¥ æ–°å¢ï¼šæˆå“¡æš±ç¨±é é¢æ¨£å¼ --- */
    .hidden { display: none !important; } /* åˆ‡æ›é é¢ç”¨ */
    
    .member-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .member-row:last-child { border-bottom: none; }
    
    .avatar { width: 40px; height: 40px; background: var(--input-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text-sub); margin-right: 12px; font-size: 16px; flex-shrink: 0; border: 1px solid var(--border); }
    
    .info { flex: 1; min-width: 0; }
    .line-name { font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
    .line-name .status { margin-right: 5px; font-size: 10px; }
    
    input.nick-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; background: var(--card-bg); outline: none; transition: border 0.2s; }
    input.nick-input:focus { border-color: var(--primary); }
    
    .btn-cancel { width: 100%; background: transparent; color: var(--text-sub); border: none; padding: 10px; font-size: 14px; cursor: pointer; margin-top: 5px; }

  </style>
</head>
<body>

<div id="loading" class="loading-overlay">
  <div class="spinner"></div>
  <p id="loading-text" style="margin-top:15px; color:var(--text-sub);">è¼‰å…¥ä¸­...</p>
</div>

<div class="header">
  <div class="icon-btn" onclick="liff.closeWindow()">âœ•</div>
  <h1 id="page-title">å¸³æœ¬è¨­å®š</h1>
  <div class="settings-area">
      <select id="theme-select" class="theme-select" onchange="changeColor(this.value)">
          <option value="green">ç¶ è‰²</option>
          <option value="blue">è—è‰²</option>
          <option value="purple">ç´«è‰²</option>
          <option value="orange">æ©˜è‰²</option>
          <option value="pink">ç²‰è‰²</option>
      </select>
      <button class="icon-btn" onclick="toggleDarkMode()">ğŸŒ™</button>
  </div>
</div>

<div class="container">

  <div id="page-general">
      <div class="card">
        <label>å¸³æœ¬åç¨± (é¡¯ç¤ºæ–¼å¡ç‰‡)</label>
        <input type="text" id="ledger-name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„è¨˜å¸³æœ¬">
      </div>

      <div class="card">
        <label>é è¨­å¹£åˆ¥</label>
        <select id="currency-select" onchange="onCurrencyChange()">
            <option value="TWD">TWD (æ–°å°å¹£)</option>
            <option value="JPY">JPY (æ—¥åœ“)</option>
            <option value="USD">USD (ç¾å…ƒ)</option>
            <option value="EUR">EUR (æ­å…ƒ)</option>
            <option value="KRW">KRW (éŸ“å…ƒ)</option>
            <option value="CNY">CNY (äººæ°‘å¹£)</option>
            <option value="THB">THB (æ³°éŠ–)</option>
            <option value="OTHER">è‡ªè¡Œè¼¸å…¥...</option>
        </select>
        <input type="text" id="currency-other" placeholder="è¼¸å…¥ä»£ç¢¼ (å¦‚ GBP)" style="display:none; margin-top:10px;" onblur="updateRateFromOther()">
      </div>

      <div class="card">
        <label>åŒ¯ç‡ (å°å°å¹£)</label>
        <div style="display:flex; align-items:center; gap:10px;">
            <input type="number" id="rate" step="0.0001" placeholder="1.0">
            <span id="fetching-msg" style="font-size:12px; color:var(--primary); display:none;">ğŸ”„ æ›´æ–°ä¸­...</span>
        </div>
        <div style="font-size:12px; color:var(--text-sub); margin-top:5px;">* é¸æ“‡å¹£åˆ¥å¾Œæœƒå˜—è©¦è‡ªå‹•æŠ“å–åŒ¯ç‡</div>
      </div>

      <div class="card">
        <label>æˆå“¡åå–® (ç”¨æ–¼åˆ†å¸³)</label>
        <div id="members-tags" class="tags-container"></div>
        <div class="input-row">
           <input type="text" id="new-member" placeholder="è¼¸å…¥åå­—...">
           <button class="btn-add" onclick="add('members-tags', 'new-member', 13)">ï¼‹</button>
        </div>
      </div>

      <div class="card">
        <label>æ¶ˆè²»åˆ†é¡</label>
        <div id="categories-tags" class="tags-container"></div>
        <div class="input-row">
           <input type="text" id="new-category" placeholder="è¼¸å…¥åˆ†é¡...">
           <button class="btn-add" onclick="add('categories-tags', 'new-category', 15)">ï¼‹</button>
        </div>
      </div>

      <div class="card">
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <div id="payments-tags" class="tags-container"></div>
        <div class="input-row">
           <input type="text" id="new-payment" placeholder="è¼¸å…¥æ–¹å¼...">
           <button class="btn-add" onclick="add('payments-tags', 'new-payment', 10)">ï¼‹</button>
        </div>
      </div>
      
      <div class="footer">
        <button class="btn-main" id="save-btn" onclick="saveGeneral()">å„²å­˜è¨­å®š</button>
      </div>
  </div>

  <div id="page-member" class="hidden">
    <div class="card">
      <label style="color:var(--primary); font-size:16px; margin-bottom:10px;">æˆå“¡æš±ç¨±è¨­å®š</label>
      <p style="font-size:13px; color:var(--text-sub); margin-bottom:15px; line-height:1.5;">
        è¨­å®šã€Œé¡¯ç¤ºåç¨±ã€å¾Œï¼Œè¨˜å¸³èˆ‡åˆ†å¸³æ™‚å°‡å„ªå…ˆé¡¯ç¤ºæ­¤åç¨±ã€‚<br>
        (è‹¥ç•™ç©ºï¼Œå‰‡é¡¯ç¤ºåŸæœ¬çš„ LINE åç¨±)
      </p>
      
      <div id="member-list-container">
        </div>
    </div>

    <div class="footer" style="flex-direction:column; gap:0;">
      <button class="btn-main" id="save-member-btn" onclick="saveMemberMapping()">å„²å­˜æš±ç¨±</button>
      <button class="btn-cancel" onclick="switchPage('general')">å›ä¸Šä¸€é </button>
    </div>
  </div>

</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ğŸ”´ è«‹å¡«å…¥æ‚¨çš„ LIFF ID (Settings çš„é‚£å€‹)
  const LIFF_ID = "2009010836-1OaNzGM2"; 

  // å…¨åŸŸè®Šæ•¸
  let gTargetId = "";
  let gSettings = { members: [], categories: [], payments: [], currency: "TWD", ledgerName: "" };
  let gMembersMap = []; // ç”¨æ–¼æš±ç¨±è¨­å®š

  window.onload = function() {
    // 1. åˆå§‹åŒ–ä¸»é¡Œ
    initTheme();

    // 2. æŠ“å–ç¶²å€åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    gTargetId = urlParams.get('targetId');
    const page = urlParams.get('page'); // åˆ¤æ–·è¦é¡¯ç¤ºå“ªä¸€é 

    // 3. åˆ‡æ›é é¢é¡¯ç¤º (å…ˆåˆ‡æ› UIï¼Œå†è®€è³‡æ–™)
    if (page === 'member') {
       switchPage('member');
    } else {
       switchPage('general');
    }

    // 4. LIFF åˆå§‹åŒ–
    liff.init({ liffId: LIFF_ID }).then(async () => {
      if (!liff.isLoggedIn()) { liff.login(); return; }
      
      const profile = await liff.getProfile();
      
      // ğŸ”¥ é‡é»ï¼šå¦‚æœç¶²å€æ²’å¸¶ ID (ä¾‹å¦‚ç›´æ¥é–‹ LIFF)ï¼Œé è¨­ä½¿ç”¨å€‹äºº ID
      if (!gTargetId) gTargetId = profile.userId;

      // 5. æ ¹æ“šé é¢è¼‰å…¥ä¸åŒè³‡æ–™
      if (page === 'member') {
          fetchData('getMemberMapping', renderMemberPage);
      } else {
          fetchData('getAllLedgerSettings', renderGeneralPage); 
          // æ³¨æ„ï¼šå¾Œç«¯å‡½å¼åæ”¹å› expenses.gs è£¡çš„ "getAllLedgerSettings"
      }

    }).catch(err => {
      alert("LIFF Error: " + err);
    });
  };

  // --- é€šç”¨å·¥å…· ---
  
  // åˆ‡æ›é é¢ UI
  function switchPage(pageName) {
     if (pageName === 'member') {
         document.getElementById('page-general').classList.add('hidden');
         document.getElementById('page-member').classList.remove('hidden');
         document.getElementById('page-title').innerText = "æˆå“¡æš±ç¨±è¨­å®š";
         document.getElementById('loading-text').innerText = "è¼‰å…¥æˆå“¡ä¸­...";
     } else {
         document.getElementById('page-general').classList.remove('hidden');
         document.getElementById('page-member').classList.add('hidden');
         document.getElementById('page-title').innerText = "å¸³æœ¬è¨­å®š";
         document.getElementById('loading-text').innerText = "è¼‰å…¥è¨­å®šä¸­...";
     }
  }

  // çµ±ä¸€å‘¼å«å¾Œç«¯ (ä½¿ç”¨ google.script.runï¼Œæ¯” fetch æ›´ç©©å®š)
  function fetchData(serverFunctionName, callback) {
     google.script.run
       .withSuccessHandler(callback)
       .withFailureHandler(err => { alert("è®€å–å¤±æ•—: " + err); document.getElementById('loading').style.display = 'none'; })
       [serverFunctionName](gTargetId); // ğŸ”¥ å‚³å…¥ gTargetId
  }

  // --- ä¸»é¡Œæ§åˆ¶ ---
  function initTheme() {
      const savedColor = localStorage.getItem('app-color') || 'green';
      const savedDark = localStorage.getItem('app-dark') === 'true';
      document.body.setAttribute('data-color', savedColor);
      document.getElementById('theme-select').value = savedColor;
      if (savedDark) document.body.classList.add('dark-mode');
  }
  function changeColor(color) {
      document.body.setAttribute('data-color', color);
      localStorage.setItem('app-color', color);
  }
  function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('app-dark', document.body.classList.contains('dark-mode'));
  }

  // ==========================================
  // ğŸŸ¢ é‚è¼¯ A: ä¸€èˆ¬è¨­å®š (General Settings)
  // ==========================================
  
  function renderGeneralPage(data) {
    if (!data) { alert("è®€å–ä¸åˆ°å¸³æœ¬è³‡æ–™"); return; }
    
    gSettings = data;
    document.getElementById('ledger-name').value = gSettings.ledgerName || "";
    
    setCurrencyUI(gSettings.currency || "TWD");
    document.getElementById('rate').value = gSettings.rate || 1;
    
    renderTags('members-tags', gSettings.members);
    renderTags('categories-tags', gSettings.categories);
    renderTags('payments-tags', gSettings.payments);
    
    hideLoading();
  }

  function renderTags(containerId, list) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    list.forEach((item, index) => {
       const tag = document.createElement('div');
       tag.className = 'tag';
       tag.innerHTML = `${item} <span class="rm" onclick="removeTag('${containerId}', ${index})">Ã—</span>`;
       container.appendChild(tag);
    });
  }

  function add(containerId, inputId, limit) {
    const input = document.getElementById(inputId);
    const val = input.value.trim();
    if(!val) return;

    let list = getListByContainer(containerId);
    if(list.includes(val)) { alert("å·²ç¶“æœ‰é€™å€‹é …ç›®äº†"); return; }
    if(list.length >= limit) { alert("é …ç›®æ•¸é‡å·²é”ä¸Šé™"); return; }

    list.push(val);
    renderTags(containerId, list);
    input.value = "";
  }

  window.removeTag = function(containerId, index) {
    let list = getListByContainer(containerId);
    if(list.length <= 1 && containerId !== 'payments-tags') { 
        alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹é …ç›®å–”ï¼"); return; 
    }
    list.splice(index, 1);
    renderTags(containerId, list);
  };

  function getListByContainer(id) {
     if(id === 'members-tags') return gSettings.members;
     if(id === 'categories-tags') return gSettings.categories;
     if(id === 'payments-tags') return gSettings.payments;
     return [];
  }

  // å„²å­˜ä¸€èˆ¬è¨­å®š
  function saveGeneral() {
    const btn = document.getElementById('save-btn');
    btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";

    var selectVal = document.getElementById('currency-select').value;
    var finalCurrency = (selectVal === "OTHER") ? document.getElementById('currency-other').value.trim().toUpperCase() : selectVal;
    if (!finalCurrency) finalCurrency = "TWD";

    const payload = {
       ledgerName: document.getElementById('ledger-name').value,
       currency: finalCurrency,
       rate: document.getElementById('rate').value,
       members: gSettings.members,
       categories: gSettings.categories,
       payments: gSettings.payments
    };

    // ğŸ”¥ ä½¿ç”¨ google.script.run å‘¼å«å¾Œç«¯ saveAllLedgerSettings
    google.script.run
      .withSuccessHandler(() => {
         alert("âœ… è¨­å®šå·²æ›´æ–°ï¼");
         liff.closeWindow();
      })
      .withFailureHandler(err => {
         alert("å„²å­˜å¤±æ•—: " + err);
         btn.disabled = false; btn.innerText = "å„²å­˜è¨­å®š";
      })
      .saveAllLedgerSettings(gTargetId, payload); // å‚³å…¥ gTargetId
  }

  // ==========================================
  // ğŸ”µ é‚è¼¯ B: æˆå“¡æš±ç¨±è¨­å®š (Member Nicknames)
  // ==========================================

  function renderMemberPage(data) {
     gMembersMap = data; // [{userId, lineName, nickname}]
     var container = document.getElementById('member-list-container');
     container.innerHTML = "";
     
     if (!data || data.length === 0) {
        container.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>å°šç„¡æˆå“¡è³‡æ–™<br>è«‹å…ˆé‚€è«‹æˆå“¡åŠ å…¥</div>";
     } else {
        data.forEach((m, idx) => {
          var div = document.createElement('div');
          div.className = 'member-row';
          
          // åˆ¤æ–·æ˜¯å¦æœ‰é€£çµ UserID (ç¶ ç‡ˆè¡¨ç¤ºæœ‰ç¶å®šï¼Œç™½ç‡ˆè¡¨ç¤ºç´”æ–‡å­—æˆå“¡)
          var statusIcon = m.userId ? "ğŸŸ¢" : "âšª"; 
          
          div.innerHTML = `
            <div class="avatar">${m.lineName.charAt(0)}</div>
            <div class="info">
              <div class="line-name"><span class="status">${statusIcon}</span>LINE: ${m.lineName}</div>
              <input type="text" class="nick-input" placeholder="è¨­å®šé¡¯ç¤ºæš±ç¨±..." 
                     value="${m.nickname || ''}" 
                     onchange="updateNick(${idx}, this.value)">
            </div>
          `;
          container.appendChild(div);
        });
     }
     hideLoading();
  }

  function updateNick(idx, val) {
     gMembersMap[idx].nickname = val.trim();
  }

  function saveMemberMapping() {
     var btn = document.getElementById('save-member-btn');
     btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";
     
     // ğŸ”¥ ä½¿ç”¨ google.script.run å‘¼å«å¾Œç«¯ saveMemberMapping
     google.script.run
       .withSuccessHandler((res) => {
          if(res && res.success) {
             alert("âœ… æš±ç¨±å·²æ›´æ–°ï¼\n(å¸³æœ¬æˆå“¡åå–®å·²åŒæ­¥)");
             liff.closeWindow();
          } else {
             alert("âŒ å„²å­˜å¤±æ•—: " + (res ? res.error : "æœªçŸ¥éŒ¯èª¤"));
             btn.disabled = false; btn.innerText = "å„²å­˜æš±ç¨±";
          }
       })
       .withFailureHandler(err => {
          alert("é€£ç·šå¤±æ•—: " + err);
          btn.disabled = false; btn.innerText = "å„²å­˜æš±ç¨±";
       })
       .saveMemberMapping(gTargetId, gMembersMap); // å‚³å…¥ gTargetId
  }

  // --- è¼”åŠ©ï¼šåŒ¯ç‡UI ---
  function onCurrencyChange() {
    var select = document.getElementById('currency-select');
    var otherInput = document.getElementById('currency-other');
    if (select.value === "OTHER") {
      otherInput.style.display = "block"; otherInput.value = ""; otherInput.focus();
    } else {
      otherInput.style.display = "none"; updateRate(select.value);
    }
  }
  function updateRateFromOther() {
    var val = document.getElementById('currency-other').value.toUpperCase();
    if (val.length === 3) updateRate(val);
  }
  function updateRate(code) {
    if (!code || code === "TWD") { document.getElementById('rate').value = 1; return; }
    document.getElementById('fetching-msg').style.display = "inline";
    fetch('https://api.exchangerate-api.com/v4/latest/' + code)
      .then(res => res.json())
      .then(data => { if(data.rates.TWD) document.getElementById('rate').value = data.rates.TWD; })
      .catch(() => {})
      .finally(() => { document.getElementById('fetching-msg').style.display = "none"; });
  }
  function setCurrencyUI(savedCurrency) {
     var select = document.getElementById('currency-select');
     var otherInput = document.getElementById('currency-other');
     var exists = Array.from(select.options).some(o => o.value === savedCurrency);
     if (exists) {
        select.value = savedCurrency; otherInput.style.display = "none";
     } else {
        select.value = "OTHER"; otherInput.style.display = "block"; otherInput.value = savedCurrency;
     }
  }
  function hideLoading() {
      document.getElementById('loading').style.opacity = '0';
      setTimeout(() => document.getElementById('loading').style.display = 'none', 300);
  }
</script>
</body>
</html>
